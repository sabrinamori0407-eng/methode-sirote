<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>La M√©thode SIROTE ‚Äì Audit Business CEO</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --p: #ff6b6b;
    --p2: #e6c677;
    --g1: #0a2342;
    --g2: #2d3142;
    --ok:#28a745; --warn:#fd7e14; --alert:#dc3545;
    --text-dark: #0a2342;
    --text-light: #fffff9;
    --bg-light: #fffff9;
    --bg-secondary: #f2ede3;
    --border-color: #e0dace;
  }
  html { scroll-behavior: smooth; }
  body{font-family:'Poppins', Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background: var(--bg-light); color: var(--text-dark); margin:0; line-height: 1.6;}
  .container{max-width:1100px;margin:32px auto;padding:0 16px}
  
  h1,h2,h3{margin:0 0 12px; font-weight: 700;}
  .main-title {
    font-size: 2.8rem;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 10px;
  }
  .mantra {
    font-size: 1.2rem;
    font-style: italic;
    color: var(--p);
    margin: 10px 0;
    font-weight: 500;
  }
  
  .content-section{background:var(--bg-light);border:1px solid var(--border-color);border-radius:16px;padding:24px;margin:0 0 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);}
  
  .btn{
    background: linear-gradient(45deg, var(--p), #ff8a8a);
    color: var(--text-light);
    border:none;
    border-radius:10px;
    padding:12px 18px;
    cursor:pointer;
    font-weight:600;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
  }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);}
  .btn:disabled{background:#ccc;cursor:not-allowed; box-shadow: none; transform: none;}
  .btn-danger{background:var(--alert)}
  .btn-warning{background:#e6c677;color:#2d3142; box-shadow: 0 4px 15px rgba(230, 198, 119, 0.3);}
  .btn-secondary{
    background: #2d3142;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  .btn-secondary:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  }
  .btn-info{
    background: var(--p2);
    color: #2d3142;
    box-shadow: 0 4px 15px rgba(230, 198, 119, 0.3);
  }
  .btn-success{background:var(--ok)}
  .btn-sm{padding:8px 12px;border-radius:8px;font-size:.9rem}
  
  .action-card{
    border:1px solid var(--border-color);
    border-radius:16px;
    padding:24px;
    cursor:pointer;
    background:var(--bg-light);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    text-align: center;
  }
  .action-card:hover{
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(45, 49, 66, 0.1);
  }
  .action-card h3 {
    color: var(--p);
  }
  
  .action-card-primary {
    background: linear-gradient(135deg, var(--g1), var(--g2));
    color: var(--text-light);
    border: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .action-card-primary:hover{
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(10, 35, 66, 0.3);
  }
  .action-card-primary h3 {
    color: var(--p2);
    margin-top: 16px;
  }
  .action-card-primary p {
    color: var(--text-light);
    opacity: 0.9;
  }
  .action-card-icon {
    height: 80px;
    width: 80px;
    object-fit: cover;
    border-radius: 12px;
  }
  
  .form-group{margin:16px 0}
  label{display:block;margin:0 0 8px;font-weight:600; font-size: 1.1rem; color: var(--text-dark);}
  .helper-btn { color: var(--p); cursor: pointer; font-size: 0.9rem; margin-left: 8px; font-weight: normal; display: inline-block;}
  input[type=text],input[type=number],select,textarea{
    width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font:inherit;box-sizing: border-box; transition: border-color 0.2s ease, box-shadow 0.2s ease;
    background: #fff;
  }
  input[type=text]:focus,input[type=number]:focus,select:focus,textarea:focus {
    border-color: var(--p);
    box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.15);
    outline: none;
  }
  textarea{min-height:100px; resize: vertical;}
  table{width:100%;border-collapse:collapse; margin-top: 12px;}
  th,td{padding:12px;border-bottom:1px solid var(--border-color);text-align:left; vertical-align: top;}
  thead th{background:var(--bg-secondary); font-weight: 600; color: var(--text-dark);}
  
  .grid{display:grid;gap:18px}
  .grid-2{grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));}
  .grid-3{grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));}
  
  .gradient-box{background:linear-gradient(135deg,var(--g1),var(--g2));color:var(--text-light);border-radius:16px;padding:24px; box-shadow: 0 8px 25px rgba(10, 35, 66, 0.2);}
  
  .audit-card{border:1px solid #eee;border-radius:12px;padding:16px;background:#fff}
  .hidden{display:none}
  small, .small{font-size:.87rem;color:#555}
  
  .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000}
  .modal-box{background:white;padding:24px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
  .question-block { margin-bottom: 24px; }
  .question-block h3 { margin-bottom: 18px; border-bottom: 2px solid var(--p); padding-bottom: 8px; color: var(--text-dark); scroll-margin-top: 20px;}
  .question-block .context { font-size: 0.9rem; color: #2d3142; margin-bottom: 8px; }
  
  .loader {
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--p);
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    display: inline-block;
    vertical-align: middle;
    margin-left: 10px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .marge-cell-bad { background-color: #ffbaba !important; }
  .marge-cell-ok { background-color: #ffdda1 !important; }
  .marge-cell-good { background-color: #c3e6cb !important; }
  
  .main-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    background-color: var(--bg-secondary);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 25px;
  }
  .nav-item {
    padding: 8px 15px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    color: var(--text-dark);
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
  }
  .nav-item:hover {
    background-color: rgba(10, 35, 66, 0.1);
  }
  .nav-item.active {
    background-color: var(--g1);
    color: var(--text-light);
  }
  .nav-item.completed::before {
    content: '‚úÖ ';
    font-size: 0.8em;
  }

  .phase-nav {
    display: flex; flex-wrap: wrap; gap: 8px; list-style-type: none; padding: 0; margin: 0 0 24px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 16px;
  }
  .phase-nav a { text-decoration: none; background: var(--bg-secondary); padding: 6px 12px; border-radius: 8px; color: var(--g2); font-size: 0.9rem;}
  .phase-nav a:hover { background: var(--p2); color: var(--g1); }

  #autosave-feedback {
    position: fixed; top: 20px; right: 20px;
    background: var(--ok); color: white;
    padding: 10px 20px; border-radius: 8px;
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    pointer-events: none;
  }
  #autosave-feedback.show { opacity: 1; }
  
  #report-view { page-break-before: always; }
  .report-header { text-align: center; margin-bottom: 40px; }
  .report-section { margin-bottom: 40px; page-break-inside: avoid; }
  .report-section h2 { border-bottom: 2px solid var(--p); padding-bottom: 10px; color: var(--text-dark); }
  .journey-map-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; }
  .journey-map { display: flex; flex-direction: row; gap: 10px; }
  .journey-step { flex: 1; min-width: 180px; background: var(--bg-secondary); border-radius: 8px; padding: 10px; border-top: 4px solid var(--p2); }
  .journey-step h4 { margin-bottom: 8px; }
  .journey-step p { font-size: 0.8rem; margin: 0 0 4px; }
  .journey-step strong { font-size: 0.8rem; }
  .report-swot { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  .report-swot div { background: var(--bg-secondary); padding: 15px; border-radius: 8px; }
  .report-swot h4 { margin-bottom: 8px; color: var(--g1) }
  .report-swot ul { padding-left: 20px; margin: 0; }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
  }
  .calendar-day {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 10px;
    min-height: 200px;
  }
  .calendar-day h4 {
    text-align: center;
    margin-bottom: 10px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 5px;
  }
  .calendar-block {
    background-color: #fff;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 8px;
    font-size: 0.8rem;
    border-left: 3px solid;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .block-strat { border-color: var(--p); }
  .block-client { border-color: var(--p2); }
  .block-off { border-color: var(--ok); }
  .block-admin { border-color: #888; }
  .block-default { border-color: #ccc; }
  
  .roadmap-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }
  .roadmap-month {
    background-color: var(--bg-secondary);
    border-radius: 12px;
    padding: 20px;
    border-top: 5px solid var(--p);
  }
  .roadmap-month h3 { color: var(--g1); }
  .roadmap-month ul { list-style-type: '‚úÖ '; padding-left: 20px; }
  .roadmap-month li { margin-bottom: 10px; }

  @media print {
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .container { max-width: 100%; margin: 0; padding: 0; }
    .no-print { display: none !important; }
    .content-section { border: none; box-shadow: none; }
    #report-view { display: block !important; }
  }
</style>
</head>
<body>
<div class="container" id="main-container">
  <div id="app"></div>
  <div id="autosave-feedback">‚úÖ Sauvegard√©</div>
</div>

<script>
/* ============================
  Utils & State
============================ */
const $app = document.getElementById('app');
let currentAuditId = null;
let autoSaveTimer = null;

function saveAudits(){ localStorage.setItem('ceoAudits', JSON.stringify(window.audits)); }
function loadAudits(){ try{ return JSON.parse(localStorage.getItem('ceoAudits')||'[]'); }catch(e){ return []; } }
window.audits = loadAudits();

const fmt = (n) => {
  const x = Number(n);
  if (!isFinite(x)) return '0';
  return x.toLocaleString('fr-FR');
};
const euro = (n) => fmt(n) + '‚Ç¨';
const escapeHtml = (s) => (s??'').toString()
  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
  .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
  .replace(/'/g,'&#039;');

function parseRevenueToNumber(r){
  if(!r) return 0;
  let s = r.split(':')[0].trim().toLowerCase();

  if (s.includes('m‚Ç¨+')) {
    const num = parseFloat(s.replace('m‚Ç¨+', ''));
    return num * 1_000_000;
  }
  
  if (s.includes('m')) {
    const parts = s.split('-');
    const low = parseFloat(parts[0].replace('k', '')) * 1000;
    const high = parseFloat(parts[1].replace('m‚Ç¨', '')) * 1_000_000;
    return (low + high) / 2;
  }

  if (s.includes('k')) {
    const nums = s.replace(/k‚Ç¨/g, '').split('-').map(Number);
    if (nums.length === 2 && !isNaN(nums[0]) && !isNaN(nums[1])) {
        return (nums[0] + nums[1]) / 2 * 1000;
    }
    if (nums.length === 1 && !isNaN(nums[0])) {
        return nums[0] * 1000;
    }
  }
  
  const d = s.match(/(\d+)/);
  return d ? Number(d[1]) * 1000 : 0;
}

const debounce = (func, delay) => {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(func, delay);
};

function showAutoSaveFeedback() {
    const feedback = document.getElementById('autosave-feedback');
    feedback.classList.add('show');
    setTimeout(() => { feedback.classList.remove('show'); }, 2000);
}

function exportAuditAsJSON(auditId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    const clientName = (audit.clientInfo.firstName + ' ' + audit.clientInfo.lastName).replace(/\s+/g, '-');
    const filename = `audit-sirote-${clientName}-${new Date().toISOString().slice(0,10)}.json`;
    const jsonStr = JSON.stringify(audit, null, 2);
    const blob = new Blob([jsonStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function triggerImport() {
    document.getElementById('import-input').click();
}

function importAuditFromJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const audit = JSON.parse(e.target.result);
            if (audit && audit.id && audit.clientInfo) {
                const existingIndex = window.audits.findIndex(a => a.id === audit.id);
                if (existingIndex > -1) {
                    window.audits[existingIndex] = audit;
                } else {
                    window.audits.push(audit);
                }
                saveAudits();
                showArchives(); 
            } else {
                alert("Fichier JSON non valide. Il manque des informations essentielles (ID, clientInfo).");
            }
        } catch (error) {
            alert("Erreur lors de la lecture du fichier JSON.");
            console.error("JSON Parse Error:", error);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function showInfoModal(title, htmlContent) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'info-modal';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box">
            <h3>${title}</h3>
            <div class="small">${htmlContent}</div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('info-modal').remove()">Fermer</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function togglePopCultureOther() {
    const select = document.getElementById('favoritePopCulture');
    const otherInput = document.getElementById('favoritePopCultureOther');
    
    if (select.value === 'Autre') {
        otherInput.classList.remove('hidden');
        otherInput.focus();
    } else {
        otherInput.classList.add('hidden');
        otherInput.value = '';
    }
}

function checkForFinalSynthesis(audit) {
    if (!audit || !audit.personalizedAudit || !audit.personalizedAudit.phases) {
        return false;
    }
    const totalPhases = audit.personalizedAudit.phases.length;
    const completedPhases = Object.keys(audit.phaseSWOTs).filter(phaseId => {
        const phaseData = audit.phaseSWOTs[phaseId];
        return phaseData && phaseData.swot && (phaseData.swot.strengths || phaseData.swot.weaknesses);
    }).length;
    return totalPhases > 0 && completedPhases === totalPhases;
}

/* ============================
  Shell / Navigation
============================ */
function hideAllSections(){ $app.innerHTML=''; }

window.showHome = function(){
  currentAuditId = null;
  hideAllSections();
  const el = document.createElement('div');
  el.className='content-section';
  el.innerHTML = `
    <div style="text-align: center; margin-bottom: 40px;">
        <h1 class="main-title">La M√©thode SIROTE</h1>
        <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin: 20px 0;">
            <span>üîß <b>S</b>yst√®mes</span>
            <span>üîó <b>I</b>nt√©gration</span>
            <span>üîÑ <b>R</b>itualisation</span>
            <span>üìã <b>O</b>rganisation</span>
            <span>ü¶ã <b>T</b>ransformation</span>
            <span>üë• <b>√â</b>quipe</span>
        </div>
        <p class="mantra">"En avant coach, c'est moi qui pilote, c'est toi qui sirotes un cocktail !"</p>
        <p class="muted">L'audit qui transforme le chaos de ton client en chor√©graphie digne de Grease.</p>
    </div>
    <div class="grid grid-2" style="margin-top:18px">
      <div class="action-card action-card-primary" onclick="startNewAudit()">
        <h3>üöÄ Lancer une nouvelle partie</h3>
        <p>Comme dans Mario, on commence au niveau 1 pour finir par sauver la princesse (la libert√© de ton client).</p>
      </div>
      <div class="action-card action-card-primary" onclick="showArchives()">
        <h3>üìú Consulter la carte du Maraudeur</h3>
        <p>Reprendre un audit en cours et espionner les secrets du business de ton client, comme √† Poudlard.</p>
      </div>
    </div>
  `;
  $app.appendChild(el);
}

window.showArchives = function() {
    hideAllSections();
    const el = document.createElement('div');
    el.className = 'content-section';

    let auditsHTML = `
        <h2 style="color: var(--p)">üìú Archives des Audits</h2>
        <p class="muted">Retrouvez ici tous les audits commenc√©s ou termin√©s.</p>
        <div class="no-print" style="margin-bottom: 20px;">
             <button class="btn" onclick="showHome()">üè† Retour √† l'accueil</button>
             <button class="btn btn-secondary" style="margin-left: 8px;" onclick="triggerImport()">Importer un Audit (JSON)</button>
             <input type="file" id="import-input" class="hidden" accept=".json" onchange="importAuditFromJSON(event)">
        </div>
    `;

    if (window.audits.length === 0) {
        auditsHTML += "<p>Aucun audit trouv√©. Il est temps de lancer votre premi√®re mission !</p>";
    } else {
        const sortedAudits = [...window.audits].sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
        auditsHTML += '<div class="grid grid-3">';
        sortedAudits.forEach(audit => {
            const clientName = escapeHtml(audit.clientInfo.firstName + ' ' + audit.clientInfo.lastName);
            const businessName = escapeHtml(audit.clientInfo.businessName);
            const lastMod = new Date(audit.lastModified).toLocaleDateString('fr-FR');
            
            auditsHTML += `
                <div class="audit-card" style="display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <h3 style="margin-bottom: 4px;">${clientName}</h3>
                        <p style="font-weight: 600; color: var(--g2); margin-top: 0;">${businessName}</p>
                        <p class="small">Derni√®re modification : ${lastMod}</p>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-sm" onclick="continueAudit('${audit.id}')">Continuer ‚Üí</button>
                        <button class="btn btn-danger btn-sm" style="margin-left: 8px;" onclick="deleteAudit('${audit.id}')">Supprimer</button>
                    </div>
                </div>
            `;
        });
        auditsHTML += '</div>';
    }

    el.innerHTML = auditsHTML;
    $app.appendChild(el);
}

function deleteAudit(auditId) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'confirm-delete-modal';
    
    modal.innerHTML = `
        <div class="modal-box">
            <h3>Confirmation de suppression</h3>
            <p>√ätes-vous s√ªr de vouloir supprimer cet audit ? Cette action est irr√©versible.</p>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('confirm-delete-modal').remove()">Annuler</button>
                <button class="btn btn-danger" style="margin-left: 8px;" id="confirm-delete-btn">Supprimer</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('confirm-delete-btn').onclick = () => {
        window.audits = window.audits.filter(a => a.id !== auditId);
        saveAudits();
        modal.remove();
        showArchives();
    };
    
    modal.onclick = (e) => { 
        if (e.target === modal) {
            modal.remove();
        }
    };
}

function renderNavigation(auditId, activeView) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return '';
    
    let navHTML = '<nav class="main-nav no-print">';
    
    const views = [
        { id: 'overview', name: 'Vue d\'ensemble', func: 'showAuditOverview' },
        { id: 'client_info', name: 'Infos Client', func: 'startNewAudit', isPhase: false },
        { id: 'questionnaire', name: 'Questionnaire', func: 'showAuditSetup' },
        { id: 'culture_avatar', name: 'Culture & Avatar', func: 'showCultureAndAvatar' },
        { id: 'brainstorm', name: 'üí° Brainstorm', func: 'showBrainstorm' }
    ];
    
    if (audit.personalizedAudit && audit.personalizedAudit.phases) {
        audit.personalizedAudit.phases.forEach(phase => {
            views.push({ id: phase.id, name: phase.name, func: 'startAuditPhase', isPhase: true });
        });
    }
    
    if (checkForFinalSynthesis(audit)) {
      views.push({ id: 'report', name: 'Rapport Final', func: 'generateFinalSynthesis' });
    }

    views.forEach(view => {
        const isActive = activeView === view.id;
        const isCompleted = audit.phaseSWOTs[view.id] && audit.phaseSWOTs[view.id].swot && audit.phaseSWOTs[view.id].swot.strengths || (view.id === 'questionnaire' && Object.keys(audit.entryData).length > 0) || (view.id === 'culture_avatar' && audit.cultureData);
        let classes = 'nav-item';
        if (isActive) classes += ' active';
        if (isCompleted) classes += ' completed';
        
        let clickHandler;
        if(view.id === 'client_info') {
            clickHandler = `startNewAudit('${auditId}')`;
        } else {
             const funcParams = view.isPhase ? `'${auditId}', '${view.id}'` : `'${auditId}'`;
             clickHandler = `saveAndNavigate('${auditId}', '${view.func}', ${funcParams})`;
        }
        
        navHTML += `<a class="${classes}" onclick="${clickHandler}">${view.name}</a>`;
    });

    navHTML += '</nav>';
    return navHTML;
}

window.saveAndNavigate = function(auditId, targetFunc, ...args) {
    saveCurrentForm(auditId);
    if (window[targetFunc]) {
        window[targetFunc](auditId, ...args.slice(1));
    }
}

window.saveCurrentForm = function(auditId, showFeedback = false) {
    const form = document.getElementById('phaseForm');
    if (!form) return;

    const phaseId = form.dataset.phaseId;
    if (!phaseId) return;
    
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    const phase = audit.personalizedAudit.phases.find(p => p.id === phaseId);
    if (!phase) return;

    const data = getFormData(phase);

    if (!audit.phaseSWOTs) audit.phaseSWOTs = {};
    if (!audit.phaseSWOTs[phaseId]) audit.phaseSWOTs[phaseId] = {};
    
    audit.phaseSWOTs[phaseId].responses = data.responses;
    audit.phaseSWOTs[phaseId].swot = data.swot;
    audit.phaseSWOTs[phaseId].maturityScore = data.maturityScore;

    audit.lastModified = new Date().toISOString();
    saveAudits();

    if (showFeedback) {
        showAutoSaveFeedback();
    }
};


/* ============================
  New audit (client info)
============================ */
window.startNewAudit = function(auditId){
  hideAllSections();
  const isNew = !auditId;
  const audit = isNew ? {} : audits.find(a => a.id === auditId);
  const clientInfo = audit.clientInfo || {};

  if (auditId) {
    currentAuditId = auditId;
  }
  
  const el = document.createElement('div');
  el.className='content-section';
  el.innerHTML = (isNew ? '' : renderNavigation(auditId, 'client_info')) + `
    <h2 style="color: var(--p)">üìã Fiche d'identit√© du client</h2>
    <form id="client-info-form" style="max-width:850px">
      <div class="grid grid-2">
        <div class="form-group"><label>Pr√©nom *</label><input id="firstName" required value="${escapeHtml(clientInfo.firstName || '')}"></div>
        <div class="form-group"><label>Nom *</label><input id="lastName" required value="${escapeHtml(clientInfo.lastName || '')}"></div>
      </div>
      <div class="form-group"><label>Nom du business *</label><input id="businessName" required value="${escapeHtml(clientInfo.businessName || '')}"></div>
      <div class="grid grid-3">
        <div class="form-group">
          <label>Chiffre d'affaires annuel *</label>
          <select id="revenue" required>
            <option value="">S√©lectionner‚Ä¶</option>
            <optgroup label="üå± Phase Lancement (0-10K‚Ç¨)">
                <option>0-5K‚Ç¨ : Bravo pour le lancement ! üöÄ LE moment pour poser les bonnes fondations d√®s maintenant</option>
                <option>5-10K‚Ç¨ : Tes premiers clients arrivent ! üéâ Cr√©er les syst√®mes pour scaler sans s'√©puiser</option>
            </optgroup>
            <optgroup label="üìà Phase Croissance (10K-200K‚Ç¨)">
                <option>10-50K‚Ç¨ : Tu d√©marres bien ! √âviter les erreurs classiques et gagner des ann√©es</option>
                <option>50-100K‚Ç¨ : Traction d√©tect√©e ! üìà Structurer avant le chaos, c'est critique !</option>
                <option>100-200K‚Ç¨ : Super croissance ! √âviter le mur des 6 chiffres, beaucoup se plantent ici...</option>
            </optgroup>
            <optgroup label="üèóÔ∏è Phase Structuration (200K-800K‚Ç¨)">
                <option>200-400K‚Ç¨ : Beau niveau ! Moment parfait pour structurer sereinement</option>
                <option>400-600K‚Ç¨ : Zone id√©ale ! Syst√®mes lib√©rateurs √† mettre en place maintenant</option>
                <option>600-800K‚Ç¨ : Tu cartonnes ! Mais prisonnier du succ√®s ? On change √ßa</option>
            </optgroup>
            <optgroup label="üëë Phase Excellence (800K‚Ç¨+)">
                <option>800K-1M‚Ç¨ : CA impressionnant ! Passage au niveau sup√©rieur scalable</option>
                <option>1M‚Ç¨+ : Cercle des champions ! Transformer en business autonome</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label>Taille de l'√©quipe *</label>
          <select id="teamSize" required>
            <option value="">S√©lectionner‚Ä¶</option>
            <option>Solo</option><option>2-3 personnes</option><option>4-6 personnes</option>
            <option>7-10 personnes</option><option>Plus de 10</option>
          </select>
        </div>
        <div class="form-group">
          <label>Type d'activit√© *</label>
          <select id="activityType" required>
            <option value="">S√©lectionner‚Ä¶</option>
            <option>Formation en ligne</option><option>Coaching individuel</option>
            <option>Mentoring/Mastermind</option><option>Conseil/Accompagnement</option>
            <option>Cr√©ation de contenu</option><option>√âv√©nements pr√©sentiels</option><option>Mixte</option>
          </select>
        </div>
      </div>
      <div class="grid grid-3">
        <div class="form-group">
          <label>Stade du business</label>
          <select id="businessStage">
            <option>Lancement r√©cent</option><option>Croissance</option><option>Maturit√©</option>
          </select>
        </div>
        <div class="form-group">
          <label>Niveau d'urgence *</label>
          <select id="urgencyLevel" required>
            <option value="">S√©lectionner‚Ä¶</option>
            <option>Risque de burn-out imminent</option>
            <option>Situation critique - urgent</option>
            <option>Besoin dans les 3 mois</option>
            <option>Planification √† moyen terme (6-12 mois)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Localisation *</label>
          <select id="localisation" required>
            <option value="">S√©lectionner‚Ä¶</option>
            <option>France</option>
            <option>Canada</option>
            <option>Belgique</option>
            <option>Suisse</option>
            <option>Expatri√©</option>
            <option>Nomade digital</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Probl√©matiques principales *</label>
        <textarea id="mainProblems" required placeholder="Ex: Je suis sous l'eau, mon √©quipe attend mes validations pour respirer, et ma To-Do List ressemble √† un rouleau de papyrus...">${escapeHtml(clientInfo.mainProblems || '')}</textarea>
      </div>
      <div class="form-group">
        <label>Objectifs prioritaires *</label>
        <textarea id="priorityObjectives" required placeholder="Ex: 1. R√©cup√©rer 10h/semaine. 2. Arr√™ter d'√™tre le goulot d'√©tranglement. 3. Pr√©parer le business pour que je puisse prendre 3 semaines OFF cet √©t√©.">${escapeHtml(clientInfo.priorityObjectives || '')}</textarea>
      </div>
        <div class="form-group">
<label>Sa r√©f√©rence Pop Culture pr√©f√©r√©e ?</label>
<p class="context small">Un film, une s√©rie, un jeu vid√©o... √áa m'aidera √† personnaliser son rapport final pour que ce soit plus fun !</p>
<select id="favoritePopCulture" onchange="togglePopCultureOther()">
  <option value="">S√©lectionner...</option>
  <optgroup label="üé¨ Cin√©ma & S√©ries">
    <option value="Harry Potter">Harry Potter</option>
    <option value="Star Wars">Star Wars</option>
    <option value="Marvel">Marvel / MCU</option>
    <option value="Le Seigneur des Anneaux">Le Seigneur des Anneaux</option>
    <option value="Matrix">Matrix</option>
    <option value="Game of Thrones">Game of Thrones</option>
    <option value="Friends">Friends</option>
    <option value="Grease">Grease</option>
    <option value="Buffy">Buffy contre les vampires</option>
    <option value="Charmed">Charmed</option>
    <option value="Les Fr√®res Scott">Les Fr√®res Scott</option>
    <option value="Grey's Anatomy">Grey's Anatomy</option>
    <option value="Stranger Things">Stranger Things</option>
    <option value="Breaking Bad">Breaking Bad</option>
    <option value="The Office">The Office</option>
    <option value="La Casa de Papel">La Casa de Papel</option>
    <option value="Peaky Blinders">Peaky Blinders</option>
    <option value="Sherlock">Sherlock</option>
    <option value="Doctor Who">Doctor Who</option>
    <option value="The Mandalorian">The Mandalorian</option>
    <option value="Gossip Girl">Gossip Girl</option>
    <option value="Sex and the City">Sex and the City</option>
    <option value="How I Met Your Mother">How I Met Your Mother</option>
    <option value="The Big Bang Theory">The Big Bang Theory</option>
    <option value="Supernatural">Supernatural</option>
    <option value="Vikings">Vikings</option>
    <option value="The Witcher">The Witcher</option>
    <option value="The Crown">The Crown</option>
    <option value="Bridgerton">Bridgerton</option>
    <option value="Emily in Paris">Emily in Paris</option>
    <option value="Pirates des Cara√Øbes">Pirates des Cara√Øbes</option>
    <option value="Titanic">Titanic</option>
    <option value="Maman j'ai rat√© l'avion">Maman j'ai rat√© l'avion</option>
    <option value="Squid Game">Squid Game</option>
    <option value="Scooby-Doo">Scooby-Doo</option>
  </optgroup>
  <optgroup label="üéÆ Jeux Vid√©o">
    <option value="Super Mario">Super Mario</option>
    <option value="The Legend of Zelda">The Legend of Zelda</option>
    <option value="Pok√©mon">Pok√©mon</option>
    <option value="Final Fantasy">Final Fantasy</option>
    <option value="The Sims">The Sims</option>
    <option value="Animal Crossing">Animal Crossing</option>
    <option value="Minecraft">Minecraft</option>
    <option value="Fortnite">Fortnite</option>
    <option value="League of Legends">League of Legends</option>
    <option value="World of Warcraft">World of Warcraft</option>
    <option value="Assassin's Creed">Assassin's Creed</option>
    <option value="The Witcher 3">The Witcher 3</option>
    <option value="Overwatch">Overwatch</option>
    <option value="Call of Duty">Call of Duty</option>
    <option value="GTA">Grand Theft Auto (GTA)</option>
    <option value="Red Dead Redemption">Red Dead Redemption</option>
    <option value="Zelda Breath of the Wild">Zelda: Breath of the Wild</option>
    <option value="Among Us">Among Us</option>
    <option value="Fall Guys">Fall Guys</option>
    <option value="Stardew Valley">Stardew Valley</option>
    <option value="Hollow Knight">Hollow Knight</option>
    <option value="Hades">Hades</option>
    <option value="Celeste">Celeste</option>
    <option value="Undertale">Undertale</option>
    <option value="Portal">Portal</option>
    <option value="Half-Life">Half-Life</option>
    <option value="Bioshock">Bioshock</option>
    <option value="Mass Effect">Mass Effect</option>
    <option value="Dragon Age">Dragon Age</option>
    <option value="Skyrim">Skyrim</option>
    <option value="Sonic">Sonic</option>
    <option value="Pac-Man">Pac-Man</option>
    <option value="Lara Croft">Tomb Raider / Lara Croft</option>
  </optgroup>
  <optgroup label="üé® Animation & Comics">
    <option value="Disney">Disney (classiques)</option>
    <option value="Pixar">Pixar</option>
    <option value="Studio Ghibli">Studio Ghibli</option>
    <option value="Dragon Ball">Dragon Ball Z</option>
    <option value="Naruto">Naruto</option>
    <option value="One Piece">One Piece</option>
    <option value="Attack on Titan">Attack on Titan</option>
    <option value="Death Note">Death Note</option>
    <option value="My Hero Academia">My Hero Academia</option>
    <option value="Batman">Batman / DC Comics</option>
    <option value="Spider-Man">Spider-Man</option>
    <option value="X-Men">X-Men</option>
    <option value="Les Simpsons">Les Simpsons</option>
    <option value="South Park">South Park</option>
    <option value="Rick et Morty">Rick et Morty</option>
    <option value="Avatar">Avatar: The Last Airbender</option>
    <option value="La Panth√®re Rose">La Panth√®re Rose</option>
    <option value="Ast√©rix">Ast√©rix et Ob√©lix</option>
    <option value="Diddl">Diddl</option>
  </optgroup>
  <optgroup label="üìö Litt√©rature & Autres">
    <option value="Percy Jackson">Percy Jackson</option>
    <option value="Hunger Games">Hunger Games</option>
    <option value="Twilight">Twilight</option>
    <option value="Divergente">Divergente</option>
    <option value="Le Tr√¥ne de Fer">Le Tr√¥ne de Fer (livres)</option>
    <option value="Dune">Dune</option>
    <option value="Fondation">Fondation (Asimov)</option>
    <option value="Orgueil et Pr√©jug√©s">Orgueil et Pr√©jug√©s</option>
  </optgroup>
  <option value="Autre">‚úèÔ∏è Autre (saisir manuellement)</option>
</select>
<input type="text" id="favoritePopCultureOther" class="hidden" placeholder="Saisissez votre r√©f√©rence..." style="margin-top: 10px;">
</div>
      <div style="margin-top:16px">
        <button type="submit" class="btn">${isNew ? 'D√©marrer le questionnaire ‚Üí' : 'Mettre √† jour et continuer ‚Üí'}</button>
        <button type="button" class="btn btn-secondary" onclick="showHome()" style="margin-left:8px">Annuler</button>
      </div>
    </form>
  `;
  $app.appendChild(el);
  
  document.getElementById('client-info-form').addEventListener('submit', function(e) {
      e.preventDefault();
      if (isNew) {
          createAudit();
      } else {
          updateClientInfo(auditId);
      }
  });

  if (!isNew) {
      document.getElementById('revenue').value = clientInfo.revenue;
      document.getElementById('teamSize').value = clientInfo.teamSize;
      document.getElementById('activityType').value = clientInfo.activityType;
      document.getElementById('businessStage').value = clientInfo.businessStage;
      document.getElementById('urgencyLevel').value = clientInfo.urgencyLevel;
      document.getElementById('localisation').value = clientInfo.localisation;
  }
// Gestion intelligente du champ Pop Culture
const popCultureSelect = document.getElementById('favoritePopCulture');
const popCultureOther = document.getElementById('favoritePopCultureOther');
const savedValue = clientInfo.favoritePopCulture || '';

// V√©rifier si la valeur existe dans le select
let optionExists = false;
for (let option of popCultureSelect.options) {
    if (option.value === savedValue) {
        optionExists = true;
        break;
    }
}

if (optionExists) {
    popCultureSelect.value = savedValue;
} else if (savedValue) {
    // Valeur personnalis√©e : s√©lectionner "Autre" et remplir le champ texte
    popCultureSelect.value = 'Autre';
    popCultureOther.value = savedValue;
    popCultureOther.classList.remove('hidden');
}
}

function getClientInfoFromForm() {
    return {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        businessName: document.getElementById('businessName').value.trim(),
        revenue: document.getElementById('revenue').value,
        teamSize: document.getElementById('teamSize').value,
        activityType: document.getElementById('activityType').value,
        businessStage: document.getElementById('businessStage').value,
        urgencyLevel: document.getElementById('urgencyLevel').value,
        localisation: document.getElementById('localisation').value,
        mainProblems: document.getElementById('mainProblems').value,
        priorityObjectives: document.getElementById('priorityObjectives').value,
        favoritePopCulture: document.getElementById('favoritePopCulture').value === 'Autre' 
    ? document.getElementById('favoritePopCultureOther').value 
    : document.getElementById('favoritePopCulture').value,
    };
}

function createAudit(){
  const clientInfo = getClientInfoFromForm();
  const audit = {
    id: 'audit_'+Date.now(),
    clientInfo,
    createdAt: new Date().toISOString(),
    lastModified: new Date().toISOString(),
    progress: 0,
    status: 'Nouveau',
    entryData: {},
    cultureData: null,
    avatarData: null,
    phaseSWOTs: {},
    personalizedAudit: null
  };
  window.audits.push(audit); saveAudits();
  showAuditSetup(audit.id);
}

function updateClientInfo(auditId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    audit.clientInfo = getClientInfoFromForm();
    audit.lastModified = new Date().toISOString();
    saveAudits();
    showAuditSetup(auditId);
}


/* ============================
  Entry questionnaire
============================ */
window.showAuditSetup = function(auditId){
  currentAuditId = auditId;
  const audit = audits.find(a=>a.id===auditId); if(!audit) return;
  hideAllSections();
  const el = document.createElement('div');
  
  const clientName = escapeHtml(audit.clientInfo.firstName);
  const businessName = escapeHtml(audit.clientInfo.businessName);

  let specificQuestionsHTML = '';

  if (audit.clientInfo.urgencyLevel.includes('burn-out')) {
    specificQuestionsHTML += `
      <div class="form-group question-block">
        <label>Signaux d'alarme</label>
        <p class="context">Quels sont ses signaux d'alarme actuels ? On est dans Buffy l√†, c'est quoi les d√©mons qui le hantent la nuit ?</p>
        <textarea id="q_burnout_signals" placeholder="Ex: Nuits de 4h, je suis irritable avec ma famille, la moindre 'urgence' me donne envie de tout plaquer..."></textarea>
      </div>
      <div class="form-group question-block">
        <label>Soulagement imm√©diat</label>
        <p class="context">S'il avait le Pouvoir des Trois (Charmed), quelles sont les 3 t√¢ches qu'il ferait dispara√Ætre DEMAIN ?</p>
        <textarea id="q_burnout_relief_tasks" placeholder="Ex: 1. La compta. 2. R√©pondre aux emails de niveau 1. 3. Faire les visuels pour les r√©seaux sociaux."></textarea>
      </div>
    `;
  }
  if (audit.clientInfo.activityType.includes('Coaching')) {
      specificQuestionsHTML += `
        <div class="form-group question-block"><label>Mod√®le coaching</label><p class="context">D√©cris son mod√®le de coaching actuel (Dur√©e, prix, format, r√©sultats)</p><textarea id="q_coaching_model" placeholder="Ex: Coaching 'Premium' sur 6 mois, 1 appel/semaine, support Slack illimit√©, 5000‚Ç¨. Objectif : doubler le MRR."></textarea></div>
        <div class="form-group question-block"><label>Goulot coaching</label><p class="context">Quel est son goulot dans ses coachings ? (Ce qui l'emp√™che de scaler)</p><textarea id="q_coaching_bottleneck" placeholder="Ex: C'est lui. Il ne peut pas prendre plus de 5 clients √† la fois sans y laisser sa sant√© mentale."></textarea></div>
      `;
  }
  
  el.innerHTML = renderNavigation(auditId, 'questionnaire') + `
    <div class="content-section">
      <h2 style="color: var(--p)">‚öôÔ∏è Questionnaire d'entr√©e pour ${clientName}</h2>
      <div class="gradient-box" style="margin:16px 0">
        <h3 style="text-align:center">üîç Debriefing du CEO</h3>
        <p style="opacity:.9;text-align:center">On rassemble ici toutes les infos cl√©s pour construire un audit sur-mesure.</p>
      </div>
      <form id="entry-questionnaire-form">
        
          <div class="question-block">
              <h3>üéØ VISION & OBJECTIFS</h3>
              <div class="form-group"><label>1. Vision 3 ans</label><p class="context">√Ä quoi ressemble ${businessName} dans 3 ans selon lui/elle ?</p><textarea id="q_vision_3_ans" placeholder="Sois concret ! '500K‚Ç¨ de CA avec une √©quipe de 8 personnes, il travaille 4j/semaine depuis Bali' plut√¥t que 'r√©ussir son business'"></textarea></div>
              <div class="form-group"><label>2. Objectifs 12 mois</label><p class="context">Quels sont ses 3 objectifs PRIORITAIRES pour les 12 prochains mois ?</p><textarea id="q_objectifs_12_mois" placeholder="1. Recruter un bras droit\n2. Atteindre 30K‚Ç¨/mois de MRR\n3. ..."></textarea></div>
              <div class="form-group"><label>3. Journ√©e id√©ale</label><p class="context">√Ä quoi ressemble sa journ√©e id√©ale de CEO lib√©r√© ?</p><textarea id="q_journee_ideale" placeholder="7h : r√©veil sans stress car il sait que tout est sous contr√¥le... 9h : 2h de strat√©gie pure... 14h : balade avec les enfants..."></textarea></div>
              <div class="form-group"><label>4. Semaine id√©ale</label><p class="context">Maintenant, la vision macro ! Du lundi au dimanche, √† quoi ressemble la semaine qui lui ferait dire "j'ai la meilleure vie" ?</p><textarea id="q_semaine_ideale" placeholder="Ex: Lundi : Strat√©gie & Vision (matin), OFF (apr√®m). Mardi/Mercredi : Calls clients importants. Jeudi : Cr√©ation de contenu. Vendredi : OFF. 30h/semaine max."></textarea></div>
          </div>

          <div class="question-block">
              <h3>üò§ PROBL√àMES & FRUSTRATIONS</h3>
              <div class="form-group"><label>5. Frustrations principales</label><p class="context">Qu'est-ce qui le/la fait le plus chier actuellement dans son business ?</p><textarea id="q_frustrations" placeholder="Sois cash ! Qu'est-ce qui le/la fait r√¢ler au quotidien ?"></textarea></div>
              <div class="form-group"><label>6. D√©connexion impossible</label><p class="context">Pourquoi n'arrive-t-il/elle pas √† d√©connecter ? La vraie raison...</p><textarea id="q_deconnexion" placeholder="J'ai peur que... / Je pense que si je ne suis pas l√†..."></textarea></div>
              <div class="form-group"><label>7. Goulot d'√©tranglement</label><p class="context">Quel est son plus gros goulot d'√©tranglement actuellement ?</p><textarea id="q_goulot" placeholder="Tout passe par moi parce que... / L'√©quipe attend toujours que..."></textarea></div>
              <div class="form-group"><label>8. Derni√®res vacances</label><p class="context">√Ä quand remontent ses derni√®res VRAIES vacances (sans ordi/t√©l√©phone pro) ?</p><textarea id="q_vacances" placeholder="Il faut que je remonte √†... / En fait jamais parce que..."></textarea></div>
          </div>

          <div class="question-block">
              <h3>üë• SON √âQUIPE ACTUELLE</h3>
              <div class="form-group"><label>9. Pr√©sentation √©quipe</label><p class="context">Pr√©sente son √©quipe : qui fait quoi ?</p><textarea id="q_equipe_presentation" placeholder="Marie : Assistante depuis 2 ans, super organis√©e mais attend toujours mes validations... Paul : Community Manager depuis 6 mois..."></textarea></div>
              <div class="form-group"><label>10. Autonomie √©quipe</label><p class="context">Sur une √©chelle de 1 √† 10, quelle est l'autonomie de son √©quipe ?</p><textarea id="q_equipe_autonomie" placeholder="Il/elle dirait X/10 parce que..."></textarea></div>
              <div class="form-group"><label>11. Profils manquants</label><p class="context">Quels profils lui manquent CRUELLEMENT ?</p><textarea id="q_equipe_manque" placeholder="Il lui faudrait absolument..."></textarea></div>
              <div class="form-group"><label>12. Communication √©quipe</label><p class="context">Comment communique-t-il/elle actuellement avec son √©quipe ?</p><textarea id="q_equipe_comm" placeholder="On utilise... / C'est un peu le bordel avec..."></textarea></div>
          </div>
          
          <div class="question-block">
              <h3>‚öôÔ∏è SYST√àMES & PROCESSUS</h3>
              <div class="form-group"><label>Syst√®mes en place</label><p class="context">A-t-il/elle des processus clairs et document√©s pour les t√¢ches r√©currentes ?</p><textarea id="q_systemes_process" placeholder="Oui, pour la facturation on a une proc√©dure sur Notion... / Non, tout est dans ma t√™te..."></textarea></div>
              <div class="form-group"><label>Logiciels de pilotage</label><p class="context">Quels logiciels principaux utilise-t-il/elle pour piloter son business ?</p><textarea id="q_systemes_logiciels" placeholder="Notion pour les projets, Stripe pour les paiements, Google Sheets pour le suivi..."></textarea></div>
              <div class="form-group"><label>Automatisation</label><p class="context">A-t-il/elle des automatisations en place ?</p><textarea id="q_systemes_automation" placeholder="Oui, j'utilise Zapier pour connecter mon calendrier √† mon autor√©pondeur... / Non, je fais tout √† la main."></textarea></div>
          </div>
          
          <div class="question-block">
              <h3>üßò √âQUILIBRE & VIE PERSONNELLE</h3>
              <div class="form-group"><label>Son grand r√™ve</label><p class="context">Au-del√† du business, c'est quoi son grand r√™ve ?</p><textarea id="q_perso_reve" placeholder="Faire le tour du monde en famille, construire une maison autonome, lancer une association..."></textarea></div>
              <div class="form-group"><label>√âquilibre pro/perso</label><p class="context">Sur une √©chelle de 1 √† 10, o√π situe-t-il/elle son √©quilibre vie pro / vie perso ?</p><textarea id="q_perso_equilibre" placeholder="Il/elle mettrait un 3/10, sa famille se plaint de ne jamais le/la voir..."></textarea></div>
              <div class="form-group"><label>Organisation en vacances</label><p class="context">Pendant ses vacances, est-il/elle vraiment OFF ?</p><textarea id="q_perso_vacances_orga" placeholder="OFF ? C'est quoi ce mot ? Il/elle checke ses mails 2h par jour... / Il/elle essaie de couper mais c'est dur..."></textarea></div>
              <div class="form-group"><label>Travailler en vacances : Choix ou Contrainte ?</label><p class="context">Est-ce un choix de bosser pendant les vacances ou est-ce parce qu'il n'est pas organis√© ? S'il avait le choix, serait-il/elle totalement OFF ou bosserait-il/elle quand m√™me ?</p><textarea id="q_perso_vacances_choix" placeholder="Ex: C'est une contrainte, si je pouvais je ne toucherais pas √† mon ordi. / Un peu des deux, j'aime bien garder un oeil mais je pourrais faire moins."></textarea></div>
              <div class="form-group"><label>Organisation en vacances (s'il/elle travaille)</label><p class="context">S'il/elle ne coupe pas, comment s'organise-t-il/elle ? C'est le chaos organis√© ou il y a un semblant de structure ?</p><textarea id="q_perso_vacances_travail" placeholder="Ex: Je bosse 2h le matin avant que tout le monde se l√®ve pour √©teindre les feux, et je re-check 1h le soir. Mais je suis jamais vraiment serein."></textarea></div>
          </div>

          <div class="question-block">
              <h3>üé™ SES ATTENTES & BESOINS</h3>
              <div class="form-group"><label>13. Attentes collaboration</label><p class="context">Qu'est-ce qu'il/elle attend CONCR√àTEMENT de votre collaboration ?</p><textarea id="q_attentes_collaboration" placeholder="Il/elle veut pouvoir... / Son r√™ve ce serait de... / Dans 6 mois il/elle aimerait..."></textarea></div>
              <div class="form-group"><label>14. Besoin prioritaire</label><p class="context">Quel est son plus grand BESOIN en ce moment ?</p><textarea id="q_besoin_prio" placeholder="Son probl√®me num√©ro 1 c'est..."></textarea></div>
              <div class="form-group"><label>15. D√©clencheur</label><p class="context">Qu'est-ce qui l'a d√©cid√© √† chercher un bin√¥me strat√©gique MAINTENANT ?</p><textarea id="q_declencheur" placeholder="Le d√©clic √ßa a √©t√© quand... / Il/elle en a eu marre de..."></textarea></div>
          </div>
          
          <div class="question-block" id="specific-questions-container">
              <h3>üî• QUESTIONS SP√âCIFIQUES</h3>
              ${specificQuestionsHTML || '<p class="muted">Aucune question sp√©cifique pour ce profil pour le moment.</p>'}
          </div>
          
          <div class="question-block">
              <h3>üåü QUESTIONS UNIVERSELLES PERSONNALIS√âES</h3>
              <div class="form-group"><label>16. Semaine type</label><p class="context">D√©cris une semaine type de ${clientName}, CEO de ${businessName}.</p><textarea id="q_semaine_type" placeholder="Lundi 7h: r√©veil stress, 8h: emails urgents, 10h: r√©union √©quipe..."></textarea></div>
              <div class="form-group"><label>17. Plus grosse perte de temps</label><p class="context">Quelle est sa plus grosse perte de temps actuellement ?</p><textarea id="q_perte_temps" placeholder="R√©pondre aux questions de base de l'√©quipe, refaire le travail des autres..."></textarea></div>
              <div class="form-group"><label>18. R√¥le CEO id√©al</label><p class="context">Dans ${businessName}, quel devrait √™tre SON r√¥le de CEO id√©al ?</p><textarea id="q_role_ideal" placeholder="Vision, strat√©gie, gros deals, innovation produit..."></textarea></div>
              <div class="form-group"><label>19. M√©triques de succ√®s</label><p class="context">Comment mesure-t-il/elle le succ√®s de son business ?</p><textarea id="q_kpis" placeholder="CA mensuel, marge, nombre de nouveaux clients, NPS..."></textarea></div>
          </div>

        <div style="margin-top:24px">
          <button type="submit" class="btn btn-success">Valider et passer √† la suite ‚Üí</button>
          <button type="button" class="btn btn-secondary" onclick="showHome()" style="margin-left:8px">Annuler</button>
        </div>
      </form>
    </div>
  `;
  $app.appendChild(el);

  if (audit.entryData) {
      Object.keys(audit.entryData).forEach(key => {
          const el = document.getElementById(key);
          if (el) el.value = audit.entryData[key];
      });
  }

  document.getElementById('entry-questionnaire-form').addEventListener('submit', (e) => {
      e.preventDefault();
      saveEntryQuestionnaire(auditId);
  });
}

window.saveEntryQuestionnaire = function(auditId){
  const audit = audits.find(a=>a.id===auditId); if(!audit) return;
  
  const questionIds = [
    'q_vision_3_ans', 'q_objectifs_12_mois', 'q_journee_ideale', 'q_semaine_ideale', 'q_frustrations',
    'q_deconnexion', 'q_goulot', 'q_vacances', 'q_equipe_presentation', 'q_equipe_autonomie',
    'q_equipe_manque', 'q_equipe_comm', 'q_attentes_collaboration', 'q_besoin_prio',
    'q_declencheur', 'q_semaine_type', 'q_perte_temps', 'q_role_ideal', 'q_kpis',
    'q_systemes_process', 'q_systemes_logiciels', 'q_systemes_automation',
    'q_perso_reve', 'q_perso_equilibre', 'q_perso_vacances_orga', 'q_perso_vacances_choix', 'q_perso_vacances_travail',
    'q_burnout_signals', 'q_burnout_relief_tasks', 'q_coaching_model', 'q_coaching_bottleneck'
  ];

  audit.entryData = {};
  questionIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
          audit.entryData[id] = el.value;
      }
  });

  audit.lastModified = new Date().toISOString();
  if(!audit.personalizedAudit) {
    audit.personalizedAudit = generatePersonalizedAudit(audit);
  }
  saveAudits();
  showCultureAndAvatar(auditId);
}

/* ============================
  Avatar Helper Modal
============================ */
window.showAvatarHelperModal = function(fieldId) {
    const avatarHelpers = {
        avatarPersonality: { 
            title: "Analyse Comportementale : Le Profilage √† la 'Esprits Criminels'", 
            content: `<ul>
                <li>Est-il/elle plut√¥t du genre Monica Geller (organis√©.e) ou Phoebe Buffay (cr√©atif/ve bord√©lique) ?</li>
                <li>Prend-il/elle des d√©cisions rapidement comme Iron Man ou a-t-il/elle besoin de consulter son conseil Jedi ?</li>
                <li>Comment r√©agit-il/elle face √† un impr√©vu : en mode Hulk (col√®re) ou Professeur X (calme et analyse) ?</li>
                <li>Quel est son "alignement" Dungeons & Dragons : Loyal Bon, Chaotique Neutre, autre ?</li>
                <li>Est-ce quelqu'un d'introverti (se ressource seul) ou d'extraverti (carbure √† l'√©nergie du groupe) ?</li>
                <li>Quelle serait sa maison √† Poudlard (Gryffondor, Serpentard, etc.) ?</li>
            </ul>` 
        },
        avatarValues: { 
            title: "Le Code des Pirates (des Cara√Øbes)", 
            content: `<ul>
                <li>Qu'est-ce qui est absolument non-n√©gociable pour lui/elle (sa "libert√©" de Jack Sparrow) ?</li>
                <li>Pour quelle cause serait-il/elle pr√™t.e √† se battre, comme Katniss Everdeen ?</li>
                <li>Quelle est la valeur fondamentale qui guide 80% de ses d√©cisions business ?</li>
                <li>S'il/elle devait r√©diger les "10 commandements" de sa vie, quel serait le premier ?</li>
                <li>Entre l'impact, l'argent et la libert√©, quel est son classement de priorit√© ?</li>
                <li>Quelle est la chose qu'il/elle ne pardonnerait jamais √† un partenaire commercial ?</li>
            </ul>` 
        },
        avatarMotivations: { 
            title: "La Qu√™te du Graal (version Kaamelott)", 
            content: `<ul>
                <li>Quel est le "Pourquoi" profond qui le/la fait sortir du lit m√™me un lundi pluvieux ?</li>
                <li>S'il/elle r√©ussit au-del√† de ses esp√©rances, √† quoi ressemblera concr√®tement sa vie ?</li>
                <li>Quelle est la reconnaissance qu'il/elle cherche vraiment (de ses pairs, sa famille, lui/elle-m√™me) ?</li>
                <li>Quel est le "boss de fin de niveau" qu'il/elle r√™ve de battre ?</li>
                <li>Pour qui fait-il/elle tout √ßa au final (sa famille, prouver quelque chose, l'impact) ?</li>
                <li>Quelle est la phrase d'encouragement qu'il/elle aimerait entendre de son mentor r√™v√© (Yoda, Dumbledore...) ?</li>
            </ul>` 
        },
        avatarFrustrations: { 
            title: "Les Gremlins dans son Business", 
            content: `<ul>
                <li>Quelle est LA t√¢che qui, si on la "mouille" avec une urgence, se transforme en cauchemar ?</li>
                <li>Quelle est la derni√®re chose qui l'a fait soupirer "j'en peux plus" devant son ordinateur ?</li>
                <li>Qu'est-ce que son √©quipe fait (ou ne fait pas) qui le/la transforme en Hulk ?</li>
                <li>Quel est le type de client ou de situation qui lui pompe toute son √©nergie ?</li>
                <li>Quelle est la r√©union ou l'interaction r√©currente qu'il/elle redoute le plus ?</li>
                <li>S'il/elle avait une baguette magique, quelle frustration ferait-il/elle dispara√Ætre en premier ?</li>
            </ul>` 
        },
        avatarObstacles: { 
            title: "Face au Balrog (Seigneur des Anneaux)", 
            content: `<ul>
                <li>Quel est le "Vous ne passerez pas !" qui bloque actuellement sa croissance ?</li>
                <li>Manque-t-il/elle de temps, de comp√©tences, de confiance ou de cl√© ? Sois pr√©cis.</li>
                <li>Quelle est la "montagne du Destin" qui lui para√Æt insurmontable en ce moment ?</li>
                <li>Quel est le plus grand obstacle externe (le march√©, la concurrence) qu'il/elle per√ßoit ?</li>
                <li>Quel est le plus grand obstacle interne (lui/elle-m√™me, son √©quipe) qu'il/elle per√ßoit ?</li>
                <li>S'il/elle avait un "cheat code" pour supprimer un obstacle, lequel choisirait-il/elle ?</li>
            </ul>` 
        },
        avatarProblems: { 
            title: "Un Jour Sans Fin... de Probl√®mes", 
            content: `<ul>
                <li>Quelle est la t√¢che r√©p√©titive qui lui donne l'impression de revivre toujours la m√™me journ√©e ?</li>
                <li>Quelle est "l'urgence" qui revient toutes les semaines, comme un mauvais √©pisode de s√©rie ?</li>
                <li>Quel est le petit grain de sable qui fait grincer toute la machine au quotidien ?</li>
                <li>Quel est le probl√®me qui le/la r√©veille √† 3h du matin ?</li>
                <li>Quelle est la question que son √©quipe lui pose le plus souvent et qui le/la rend dingue ?</li>
                <li>Quel est le probl√®me qu'il/elle repousse constamment au lendemain ?</li>
            </ul>` 
        },
        avatarFears: { 
            title: "Les D√©traqueurs de l'Entrepreneur", 
            content: `<ul>
                <li>Quelle est sa plus grande peur si rien ne change dans 1 an ?</li>
                <li>De quoi a-t-il/elle peur s'il/elle r√©ussit (la fameuse peur du succ√®s) ?</li>
                <li>Quelle est la petite voix de Gollum dans sa t√™te qui lui murmure des doutes ?</li>
                <li>Quelle est la pire chose qui pourrait arriver √† son business selon lui/elle ?</li>
                <li>A-t-il/elle peur de d√©cevoir quelqu'un en particulier (sa famille, ses clients, lui/elle-m√™me) ?</li>
                <li>S'il/elle est honn√™te, quelle est la peur irrationnelle qui le/la freine le plus ?</li>
            </ul>` 
        },
        avatarLimitingBeliefs: { 
            title: "Casser la Matrice (et ses Croyances)", 
            content: `<ul>
                <li>Quelle est la "pilule rouge" sur son business qu'il/elle refuse de voir ?</li>
                <li>Quelle phrase commen√ßant par "Je ne suis pas assez..." ou "Je dois..." se r√©p√®te-t-il/elle ?</li>
                <li>S'il/elle n'avait aucune limite (argent, temps, peur), que ferait-il/elle diff√©remment DEMAIN ?</li>
                <li>Quelle est la "r√®gle" qu'il/elle s'impose et qui n'existe que dans sa t√™te ?</li>
                <li>Pense-t-il/elle qu'il faut "travailler dur pour r√©ussir" ou est-il/elle ouvert.e √† plus de fluidit√© ?</li>
                <li>Quelle croyance h√©rit√©e de son pass√© (√©ducation, anciens jobs) sabote son pr√©sent de CEO ?</li>
            </ul>` 
        },
        avatarDesires: { 
            title: "Les 7 Boules de Cristal", 
            content: `<ul>
                <li>S'il/elle pouvait faire un v≈ìu √† Shenron pour son business, quel serait-il (hors "plus de CA") ?</li>
                <li>Quel est le SENTIMENT profond qu'il/elle recherche (s√©r√©nit√©, libert√©, fiert√©, s√©curit√©) ?</li>
                <li>D√©cris la sc√®ne exacte qu'il/elle s'imagine quand il/elle pense √† sa "r√©ussite".</li>
                <li>Au fond, d√©sire-t-il/elle plus de temps, plus d'argent, ou plus d'impact ?</li>
                <li>Quel est le d√©sir secret pour sa vie perso que son business doit permettre de r√©aliser ?</li>
                <li>Quelle est la premi√®re chose qu'il/elle ferait s'il/elle atteignait son objectif ultime demain ?</li>
            </ul>` 
        },
        avatarNeeds: { 
            title: "Le Kit de Survie de MacGyver", 
            content: `<ul>
                <li>De quel "outil" (comp√©tence, personne, syst√®me) a-t-il/elle le plus besoin pour se sortir du p√©trin ?</li>
                <li>Si Batman a Alfred, de quel type d'"Alfred" (assistant, mentor, COO) aurait-il/elle besoin ?</li>
                <li>Quelle est LA pi√®ce manquante du puzzle de son business ?</li>
                <li>A-t-il/elle besoin de plus de structure ou de plus de flexibilit√© en ce moment ?</li>
                <li>De quel type de soutien a-t-il/elle le plus besoin : strat√©gique, op√©rationnel ou √©motionnel ?</li>
                <li>Quelle est la chose qu'il/elle ne sait pas faire et qui lui co√ªte le plus cher (en temps/argent) ?</li>
            </ul>` 
        },
        avatarUltimateDream: { 
            title: "Retour vers le Futur (Id√©al)", 
            content: `<ul>
                <li>Si on se projette dans 5 ans, √† quoi ressemble la "fin du film" id√©ale ?</li>
                <li>O√π est-il/elle ? Que fait-il/elle ? Et surtout, que ne fait-il/elle PLUS du tout ?</li>
                <li>Quel impact concret a-t-il/elle laiss√© sur son march√© ou ses clients ?</li>
                <li>Quel h√©ritage (legacy) veut-il/elle construire avec son entreprise ?</li>
                <li>Comment son business a-t-il transform√© sa vie de famille et sa vie personnelle ?</li>
                <li>Quelle est la chose folle qu'il/elle se sera enfin autoris√©e √† faire gr√¢ce √† sa r√©ussite ?</li>
            </ul>` 
        },
        avatarHobbies: { 
            title: "Dans la Batcave du CEO", 
            content: `<ul>
                <li>Quand il/elle n'est pas en train de sauver son business, que fait-il/elle pour vraiment d√©connecter ?</li>
                <li>Quelle est la passion ou l'activit√© qui le/la ressource et lui redonne de l'√©nergie ?</li>
                <li>Quel est son "plaisir coupable" sur Netflix, YouTube ou un autre m√©dia ?</li>
                <li>S'il/elle avait un apr√®s-midi de libre inattendu, comment l'utiliserait-il/elle ?</li>
                <li>Quel est le voyage ou l'exp√©rience qu'il/elle r√™ve de faire ?</li>
                <li>Pratique-t-il/elle un sport ou une activit√© cr√©ative ?</li>
            </ul>` 
        },
        avatarDislikes: { 
            title: "La Liste Noire de Dexter", 
            content: `<ul>
                <li>Qu'est-ce qui le/la fait grincer des dents dans son secteur d'activit√© ?</li>
                <li>Quelle est la phrase typique de "mauvais client" qui le/la fait fuir en courant ?</li>
                <li>Quel type de t√¢che lui donne envie de jeter son ordinateur par la fen√™tre ?</li>
                <li>Quelle est la tendance business actuelle qu'il/elle d√©teste le plus ?</li>
                <li>Quel comportement chez un collaborateur est un "red flag" imm√©diat pour lui/elle ?</li>
                <li>Quelle est la chose qu'il/elle ne refera "plus jamais" dans son business ?</li>
            </ul>` 
        },
        avatarContentConsumption: { 
            title: "Le Menu M√©dia du Jedi", 
            content: `<ul>
                <li>O√π va-t-il/elle chercher l'info et l'inspiration (podcasts, newsletters, blogs, livres...) ?</li>
                <li>Quels sont les 3 "Ma√Ætres Jedi" (influenceurs, auteurs) qu'il/elle suit et respecte le plus ?</li>
                <li>Sur quel r√©seau social passe-t-il/elle du temps pour se d√©tendre (ou procrastiner) ?</li>
                <li>Quel est le dernier livre ou la derni√®re formation qui a chang√© sa vision des choses ?</li>
                <li>Pr√©f√®re-t-il/elle les formats courts (TikTok, posts LinkedIn) ou longs (livres, documentaires) ?</li>
                <li>Quelle est LA newsletter qu'il/elle lit vraiment ?</li>
            </ul>` 
        }
    };

    const helperData = avatarHelpers[fieldId];
    if (!helperData) return;

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'helper-modal';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box">
            <h3>${helperData.title}</h3>
            <div class="small">${helperData.content}</div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('helper-modal').remove()">OK, j'ai compris !</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

/* ============================
  Culture & Avatar
============================ */
window.showCultureAndAvatar = function(auditId){
  currentAuditId = auditId;
  const audit = audits.find(a=>a.id===auditId); if(!audit) return;
  hideAllSections();

  const el = document.createElement('div');
  el.innerHTML = renderNavigation(auditId, 'culture_avatar');

  const content = document.createElement('div');
  content.className='content-section';
  content.innerHTML = `
    <h2 style="color: var(--p)">üé® Culture d'Entreprise & Avatar Client</h2>
    <p class="muted">Cette section est facultative mais fortement recommand√©e pour un audit complet.</p>
    <form id="culture-avatar-form">
      <div class="content-section" style="border-color:#f3e5f5">
        <div class="form-group"><label>Valeurs fondamentales</label><textarea id="companyValues" placeholder="Authenticit√©, Excellence, Kiff. En gros, on fait du super boulot, sans se prendre pour des gourous."></textarea></div>
        <div class="form-group"><label>Valeurs en action (concret)</label><textarea id="valuesInAction" placeholder="Quand un client est content, on envoie des GIFs de chatons. Quand on se plante, on dit 'my bad' et on corrige. Pas de bullshit."></textarea></div>
        <div class="grid grid-3">
          <div class="form-group"><label>Mission</label><textarea id="companyMission" placeholder="Aider les entrepreneurs √† construire une machine qui tourne sans eux, pour qu'ils puissent enfin aller boire des mojitos √† la plage."></textarea></div>
          <div class="form-group"><label>Vision</label><textarea id="companyVision" placeholder="Devenir la r√©f√©rence anti-burnout pour les CEO. Le genre de bo√Æte o√π tu signes en te disant 'enfin, des gens normaux !'."></textarea></div>
          <div class="form-group"><label>Business dans 3 ans</label><textarea id="futureVision" placeholder="Une √©quipe de 5 ninjas autonomes, 1M‚Ç¨ de CA en kiffant, et moi qui bosse 3 jours par semaine depuis un van."></textarea></div>
        </div>
      </div>

      <div class="gradient-box" style="background:linear-gradient(135deg,#667eea,#764ba2);margin:16px 0">
        <h3 style="text-align:center">üë§ Avatar client id√©al</h3>
         <p style="text-align:center;opacity:.9">Pour qui ton client se l√®ve le matin (√† part pour son caf√©).</p>
      </div>

      <div class="content-section">
        <div class="grid grid-2">
          <div class="form-group"><label>Pr√©nom (avatar)</label><input id="avatarFirstName" placeholder="Sophie"></div>
          <div class="form-group"><label>Nom (avatar)</label><input id="avatarLastName" placeholder="Durand (ou Skywalker, si elle est ambitieuse)"></div>
        </div>
        <div class="grid grid-3">
          <div class="form-group"><label>√Çge</label><input id="avatarAge" placeholder="38 ans, l'√¢ge de raison... ou pas."></div>
          <div class="form-group"><label>Sexe</label>
            <select id="avatarGender"><option>Femme</option><option>Homme</option><option>Non binaire</option></select>
          </div>
          <div class="form-group"><label>Situation familiale</label><input id="avatarFamily" placeholder="Mari√©e, 2 mini-boss √† g√©rer √† la maison."></div>
        </div>
        <div class="grid grid-2">
          <div class="form-group"><label>Revenus annuels</label><input id="avatarIncome" placeholder="150K‚Ç¨, assez pour bien vivre mais pas encore pour acheter une √Æle."></div>
          <div class="form-group"><label>Localisation</label><input id="avatarLocation" placeholder="Une grande ville, ou en t√©l√©travail car le m√©tro c'est l'enfer."></div>
        </div>
        <div class="grid grid-3">
          <div class="form-group"><label>Personnalit√©<span class="helper-btn" onclick="showAvatarHelperModal('avatarPersonality')">üí° Aide</span></label><textarea id="avatarPersonality" placeholder="Ambitieuse mais cool. Le genre de personne avec qui tu peux parler chiffres et blagues de Toto dans la m√™me phrase."></textarea></div>
          <div class="form-group"><label>Valeurs<span class="helper-btn" onclick="showAvatarHelperModal('avatarValues')">üí° Aide</span></label><textarea id="avatarValues" placeholder="Libert√©, impact, famille. Elle veut changer le monde, mais pas au d√©triment de sa vie perso."></textarea></div>
          <div class="form-group"><label>Motivations<span class="helper-btn" onclick="showAvatarHelperModal('avatarMotivations')">üí° Aide</span></label><textarea id="avatarMotivations" placeholder="Prouver qu'on peut cartonner sans sacrifier sa sant√© mentale. Et s'acheter une belle maison, faut pas d√©conner."></textarea></div>
        </div>
        <div class="grid grid-3">
          <div class="form-group"><label>Frustrations <span class="helper-btn" onclick="showAvatarHelperModal('avatarFrustrations')">üí° Aide</span></label><textarea id="avatarFrustrations" placeholder="√ätre le goulot d'√©tranglement de sa propre bo√Æte. Se sentir comme un hamster dans une roue."></textarea></div>
          <div class="form-group"><label>Obstacles <span class="helper-btn" onclick="showAvatarHelperModal('avatarObstacles')">üí° Aide</span></label><textarea id="avatarObstacles" placeholder="Son √©quipe qui lui demande la permission pour respirer. Le syndrome de la bonne √©l√®ve."></textarea></div>
          <div class="form-group"><label>Probl√®mes quotidiens<span class="helper-btn" onclick="showAvatarHelperModal('avatarProblems')">üí° Aide</span></label><textarea id="avatarProblems" placeholder="Sa to-do list qui ressemble √† un rouleau de papyrus. Les 'urgences' qui n'en sont pas."></textarea></div>
        </div>
        <div class="grid grid-3">
          <div class="form-group"><label>Peurs <span class="helper-btn" onclick="showAvatarHelperModal('avatarFears')">üí° Aide</span></label><textarea id="avatarFears" placeholder="Devenir esclave de sa r√©ussite. Se r√©veiller √† 50 ans en ayant rat√© la kermesse des gosses."></textarea></div>
          <div class="form-group"><label>Croyances limitantes<span class="helper-btn" onclick="showAvatarHelperModal('avatarLimitingBeliefs')">üí° Aide</span></label><textarea id="avatarLimitingBeliefs" placeholder="'Si je ne le fais pas moi-m√™me, ce sera mal fait.' La phrase qui a caus√© 99% des burn-outs."></textarea></div>
          <div class="form-group"><label>D√©sirs <span class="helper-btn" onclick="showAvatarHelperModal('avatarDesires')">üí° Aide</span></label><textarea id="avatarDesires" placeholder="Se lever le matin sans avoir une boule au ventre. Partir en vacances et VRAIMENT d√©connecter."></textarea></div>
        </div>
        <div class="grid grid-3">
          <div class="form-group"><label>Besoins<span class="helper-btn" onclick="showAvatarHelperModal('avatarNeeds')">üí° Aide</span></label><textarea id="avatarNeeds" placeholder="D'un cerveau externe. D'un syst√®me. D'un bin√¥me qui lui dit 't'inqui√®te, je g√®re'."></textarea></div>
          <div class="form-group"><label>R√™ve ultime<span class="helper-btn" onclick="showAvatarHelperModal('avatarUltimateDream')">üí° Aide</span></label><textarea id="avatarUltimateDream" placeholder="Que sa bo√Æte tourne comme une horloge suisse pendant qu'elle fait un stage de poterie au P√©rou."></textarea></div>
          <div class="form-group"><label>Hobbies<span class="helper-btn" onclick="showAvatarHelperModal('avatarHobbies')">üí° Aide</span></label><textarea id="avatarHobbies" placeholder="Yoga, quand elle a le temps. Netflix, pour d√©compresser. R√™ver de ses prochaines vacances."></textarea></div>
        </div>
        <div class="grid grid-2">
          <div class="form-group"><label>Ce qu'elle d√©teste<span class="helper-btn" onclick="showAvatarHelperModal('avatarDislikes')">üí° Aide</span></label><textarea id="avatarDislikes" placeholder="Les r√©unions inutiles. Le micromanagement. Les gens qui disent 'on a toujours fait comme √ßa'."></textarea></div>
          <div class="form-group"><label>Consommation de contenu<span class="helper-btn" onclick="showAvatarHelperModal('avatarContentConsumption')">üí° Aide</span></label><textarea id="avatarContentConsumption" placeholder="Podcasts business dans les bouchons, newsletters inspirantes, et des memes sur Instagram pour garder le moral."></textarea></div>
        </div>
      </div>

      <div style="margin-top:14px">
        <button type="submit" class="btn">Enregistrer et Continuer ‚Üí</button>
        <button type="button" class="btn btn-secondary" style="margin-left:8px" onclick="showAuditSetup('${auditId}')">‚Üê Retour</button>
      </div>
    </form>
  `;
  el.appendChild(content);
  $app.appendChild(el);

    if (audit.cultureData) {
        Object.keys(audit.cultureData).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = audit.cultureData[id];
        });
    }
    if (audit.avatarData) {
        Object.keys(audit.avatarData).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = audit.avatarData[id];
        });
    }


  document.getElementById('culture-avatar-form').addEventListener('submit', (e) => {
      e.preventDefault();
      saveCultureAndAvatar(auditId);
  });
}

window.saveCultureAndAvatar = function(auditId){
  const audit = audits.find(a=>a.id===auditId); if(!audit) return;
    
    const cultureIds = ['companyValues', 'valuesInAction', 'companyMission', 'companyVision', 'futureVision'];
    const avatarIds = ['avatarFirstName', 'avatarLastName', 'avatarAge', 'avatarGender', 'avatarFamily', 'avatarIncome', 'avatarLocation', 'avatarPersonality', 'avatarValues', 'avatarMotivations', 'avatarFrustrations', 'avatarObstacles', 'avatarProblems', 'avatarFears', 'avatarLimitingBeliefs', 'avatarDesires', 'avatarNeeds', 'avatarUltimateDream', 'avatarHobbies', 'avatarDislikes', 'avatarContentConsumption'];

    audit.cultureData = {};
    cultureIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) audit.cultureData[id] = el.value;
    });

    audit.avatarData = {};
    avatarIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) audit.avatarData[id] = el.value;
    });

  audit.lastModified = new Date().toISOString();
  saveAudits();
  showAuditOverview(auditId);
}

/* ============================
  Final Report Generation
============================ */

const reportThemes = {
    default: {
        title: (name) => `Rapport d'Audit Strat√©gique pour ${name}`,
        swotTitle: "Analyse SWOT Synth√©tique",
        strengths: "Forces",
        weaknesses: "Faiblesses",
        opportunities: "Opportunit√©s",
        threats: "Menaces",
        radarTitle: "Radar de Maturit√© du Business",
        roadmapTitle: "Feuille de Route Recommand√©e",
        summaryTitle: "R√©sum√© Ex√©cutif",
        icon: "üìä"
    },
    harryPotter: {
        title: (name) => `La Carte du Maraudeur pour ${name}`,
        swotTitle: "Analyse des Sortil√®ges et Mal√©fices",
        strengths: "Sortil√®ges R√©ussis",
        weaknesses: "Mal√©fices √† Contrer",
        opportunities: "Potions de Croissance",
        threats: "D√©traqueurs en Vue",
        radarTitle: "Analyse via le Choixpeau Magique",
        roadmapTitle: "Votre Potion de Croissance",
        summaryTitle: "Proph√©tie du Professeur Trelawney",
        icon: "üìú"
    },
    marvel: {
        title: (name) => `Dossier Strat√©gique Stark Industries pour ${name}`,
        swotTitle: "Analyse du Tesseract",
        strengths: "Super-Pouvoirs",
        weaknesses: "Kryptonite",
        opportunities: "Portails Interdimensionnels",
        threats: "L'Arriv√©e de Thanos",
        radarTitle: "Niveau de Puissance (Scouter)",
        roadmapTitle: "Le Protocole Avengers",
        summaryTitle: "Message de Nick Fury",
        icon: "üõ°Ô∏è"
    },
    starWars: {
        title: (name) => `Transmission de l'Alliance Rebelle pour ${name}`,
        swotTitle: "√âquilibre de la Force",
        strengths: "Le C√¥t√© Lumineux",
        weaknesses: "Le C√¥t√© Obscur",
        opportunities: "Nouveaux Syst√®mes Solaires √† Explorer",
        threats: "L'√âtoile de la Mort",
        radarTitle: "Mesure du Taux de Midi-chloriens",
        roadmapTitle: "Les Plans de l'√âtoile Noire",
        summaryTitle: "Message de la Princesse Leia",
        icon: "üöÄ"
    },
    mario: {
        title: (name) => `üçÑ Guide Strat√©gique Super Mario pour ${name}`,
        swotTitle: "Analyse des Power-Ups",
        strengths: "Super √âtoiles",
        weaknesses: "Tuyaux Bloqu√©s",
        opportunities: "Pi√®ces d'Or √† Collecter",
        threats: "Bowser & Ses Sbires",
        radarTitle: "Niveau de Power-Up",
        roadmapTitle: "Carte des Mondes",
        summaryTitle: "Message de la Princesse Peach",
        icon: "üçÑ"
    },
    zelda: {
        title: (name) => `‚öîÔ∏è Qu√™te L√©gendaire pour ${name}`,
        swotTitle: "Inventaire de Link",
        strengths: "Triforce du Courage",
        weaknesses: "Points Faibles",
        opportunities: "Donjons √† Explorer",
        threats: "Forces de Ganon",
        radarTitle: "Jauge de Coeur",
        roadmapTitle: "Carte d'Hyrule",
        summaryTitle: "Proph√©tie de Zelda",
        icon: "‚öîÔ∏è"
    },
    pokemon: {
        title: (name) => `‚ö° Pok√©dex Strat√©gique pour ${name}`,
        swotTitle: "Analyse de l'√âquipe",
        strengths: "Attaques Efficaces",
        weaknesses: "Faiblesses Type",
        opportunities: "Nouvelles Captures",
        threats: "Rival & Team Rocket",
        radarTitle: "Niveau des Pok√©mon",
        roadmapTitle: "Route vers la Ligue",
        summaryTitle: "Conseil du Professeur Chen",
        icon: "‚ö°"
    },
    lotr: {
        title: (name) => `üßô Conseil d'Elrond pour ${name}`,
        swotTitle: "Analyse de la Communaut√©",
        strengths: "Les H√©ros de la Terre du Milieu",
        weaknesses: "La Corruption de l'Anneau",
        opportunities: "Alliances √† Forger",
        threats: "L'≈íil de Sauron",
        radarTitle: "Puissance de la Communaut√©",
        roadmapTitle: "Chemin vers la Montagne du Destin",
        summaryTitle: "Proph√©tie de Gandalf",
        icon: "üßô"
    },
    matrix: {
        title: (name) => `üíä Rapport de la Matrice pour ${name}`,
        swotTitle: "Analyse du Code",
        strengths: "Comp√©tences D√©bloqu√©es",
        weaknesses: "Bugs du Syst√®me",
        opportunities: "Glitchs √† Exploiter",
        threats: "Les Agents",
        radarTitle: "Niveau de Conscience",
        roadmapTitle: "Chemin de l'√âlu",
        summaryTitle: "Message de Morpheus",
        icon: "üíä"
    },
    got: {
        title: (name) => `üêâ Conseil des Ma√Ætres pour ${name}`,
        swotTitle: "Strat√©gie du Tr√¥ne de Fer",
        strengths: "Vos Arm√©es",
        weaknesses: "Trahisons Potentielles",
        opportunities: "Alliances Strat√©giques",
        threats: "Ennemis du Royaume",
        radarTitle: "Pouvoir des Maisons",
        roadmapTitle: "Conqu√™te de Westeros",
        summaryTitle: "Conseil de Tyrion",
        icon: "üêâ"
    },
    friends: {
        title: (name) => `‚òï Plan Central Perk pour ${name}`,
        swotTitle: "Analyse du Groupe",
        strengths: "On √âtait en Pause ! (Victoires)",
        weaknesses: "Moments G√™nants",
        opportunities: "Nouvelles Opportunit√©s",
        threats: "Drama √† G√©rer",
        radarTitle: "Niveau d'Amiti√©",
        roadmapTitle: "Plan pour R√©ussir",
        summaryTitle: "Conseil de Monica (la plus organis√©e)",
        icon: "‚òï"
    },
    disney: {
        title: (name) => `‚ú® Plan Magique Disney pour ${name}`,
        swotTitle: "Analyse des Sortil√®ges",
        strengths: "Magie & R√™ves",
        weaknesses: "Mal√©dictions",
        opportunities: "V≈ìux √† R√©aliser",
        threats: "Les M√©chants",
        radarTitle: "Niveau de Magie",
        roadmapTitle: "Chemin vers le Conte de F√©es",
        summaryTitle: "Message de la F√©e Marraine",
        icon: "‚ú®"
    },
    grease: {
        title: (name) => `üé∏ Plan Rydell High pour ${name}`,
        swotTitle: "Analyse des T-Birds & Pink Ladies",
        strengths: "You're the One That I Want",
        weaknesses: "Tell Me More, Tell Me More",
        opportunities: "Summer Nights",
        threats: "Obstacles √† Surmonter",
        radarTitle: "Niveau de Cool",
        roadmapTitle: "Route vers le Happy End",
        summaryTitle: "Conseil de Rizzo (la plus pragmatique)",
        icon: "üé∏"
    },
    dragonball: {
        title: (name) => `üêâ Capsule Corp Strategy pour ${name}`,
        swotTitle: "Analyse du Niveau de Combat",
        strengths: "Transformations Ma√Ætris√©es",
        weaknesses: "Points Faibles en Combat",
        opportunities: "Nouvelles Techniques √† Apprendre",
        threats: "Ennemis Redoutables",
        radarTitle: "Scouter de Puissance",
        roadmapTitle: "Entra√Ænement de Kam√© Sense√Ø",
        summaryTitle: "Conseil de Ma√Ætre Kame",
        icon: "üêâ"
    },
    naruto: {
        title: (name) => `üçú Plan Strat√©gique de Konoha pour ${name}`,
        swotTitle: "Analyse des Techniques Ninja",
        strengths: "Jutsu Ma√Ætris√©s",
        weaknesses: "Faiblesses du Chakra",
        opportunities: "Nouveaux Alli√©s",
        threats: "Organisations Ennemies",
        radarTitle: "Niveau de Chakra",
        roadmapTitle: "Chemin du Hokage",
        summaryTitle: "Conseil de Kakashi Sensei",
        icon: "üçú"
    },
    onepiece: {
        title: (name) => `üè¥‚Äç‚ò†Ô∏è Carte au Tr√©sor pour ${name}`,
        swotTitle: "Analyse de l'√âquipage",
        strengths: "Fruits du D√©mon",
        weaknesses: "Primes sur vos T√™tes",
        opportunities: "√éles √† D√©couvrir",
        threats: "La Marine & les Empereurs",
        radarTitle: "Niveau de Haki",
        roadmapTitle: "Route vers One Piece",
        summaryTitle: "Message de Gold Roger",
        icon: "üè¥‚Äç‚ò†Ô∏è"
    },
    sonic: {
        title: (name) => `ü¶î Plan Vitesse Supersonique pour ${name}`,
        swotTitle: "Analyse des Anneaux d'Or",
        strengths: "Super Vitesse",
        weaknesses: "Zones Lentes",
        opportunities: "√âmeraudes du Chaos",
        threats: "Dr. Robotnik",
        radarTitle: "Compteur de Vitesse",
        roadmapTitle: "Green Hill Zone Map",
        summaryTitle: "Conseil de Tails",
        icon: "ü¶î"
    },
    pacman: {
        title: (name) => `üëª Strat√©gie Labyrinthe pour ${name}`,
        swotTitle: "Analyse du Terrain de Jeu",
        strengths: "Super Pac-Gommes",
        weaknesses: "Angles Morts",
        opportunities: "Bonus √† R√©cup√©rer",
        threats: "Fant√¥mes Hostiles",
        radarTitle: "Score de Performance",
        roadmapTitle: "Plan du Labyrinthe",
        summaryTitle: "Strat√©gie Anti-Fant√¥mes",
        icon: "üëª"
    },
    charmed: {
        title: (name) => `‚ú® Livre des Ombres pour ${name}`,
        swotTitle: "Analyse du Pouvoir des Trois",
        strengths: "Sorts Ma√Ætris√©s",
        weaknesses: "Vuln√©rabilit√©s Magiques",
        opportunities: "Nouvelles Potions",
        threats: "Forces du Mal",
        radarTitle: "Niveau de Magie Blanche",
        roadmapTitle: "Grimoire de Bataille",
        summaryTitle: "Conseil de Grams",
        icon: "‚ú®"
    },
    buffy: {
        title: (name) => `üßõ Rapport du Conseil des Observateurs pour ${name}`,
        swotTitle: "Analyse de la Tueuse",
        strengths: "Pouvoirs de Tueuse",
        weaknesses: "Points Faibles Tactiques",
        opportunities: "Nouveaux Alli√©s du Scooby Gang",
        threats: "Apocalypses Imminentes",
        radarTitle: "Niveau de Combat Vampirique",
        roadmapTitle: "Plan Anti-Apocalypse",
        summaryTitle: "Conseil de Giles",
        icon: "üßõ"
    },
    panthere: {
        title: (name) => `üéµ Enqu√™te de l'Inspecteur pour ${name}`,
        swotTitle: "Analyse en Mode Furtif",
        strengths: "Discr√©tion Maximale",
        weaknesses: "Indices Manqu√©s",
        opportunities: "Nouvelles Pistes",
        threats: "Obstacles Inattendus",
        radarTitle: "Niveau de Finesse",
        roadmapTitle: "Plan d'Investigation",
        summaryTitle: "D√©duction Finale",
        icon: "üéµ"
    },
    cod: {
        title: (name) => `üéÆ Briefing Tactique Call of Duty pour ${name}`,
        swotTitle: "Analyse de Mission",
        strengths: "Armement & √âquipement",
        weaknesses: "Positions Vuln√©rables",
        opportunities: "Objectifs Secondaires",
        threats: "Forces Ennemies",
        radarTitle: "K/D Ratio",
        roadmapTitle: "Plan d'Op√©ration",
        summaryTitle: "Briefing du Capitaine Price",
        icon: "üéÆ"
    },
    laracroft: {
        title: (name) => `üî´ Journal d'Exploration pour ${name}`,
        swotTitle: "Analyse des Ruines",
        strengths: "√âquipement d'Aventurier",
        weaknesses: "Pi√®ges Non D√©tect√©s",
        opportunities: "Art√©facts L√©gendaires",
        threats: "Organisations Rivales",
        radarTitle: "Niveau d'Exploration",
        roadmapTitle: "Carte des Tombeaux",
        summaryTitle: "Notes de Lara Croft",
        icon: "üî´"
    },
    sims: {
        title: (name) => `üè† Plan de Vie Parfaite pour ${name}`,
        swotTitle: "Analyse des Besoins",
        strengths: "Comp√©tences D√©velopp√©es",
        weaknesses: "Jauges dans le Rouge",
        opportunities: "Promotions & Relations",
        threats: "Factures & Incendies",
        radarTitle: "Niveau de Satisfaction",
        roadmapTitle: "Objectifs de Vie",
        summaryTitle: "Conseil du Conseiller Carri√®re",
        icon: "üè†"
    },
    scoobydoo: {
        title: (name) => `üêï Rapport du Mystery Machine pour ${name}`,
        swotTitle: "Analyse du Myst√®re",
        strengths: "Indices D√©couverts",
        weaknesses: "Fausses Pistes",
        opportunities: "Nouveaux Suspects",
        threats: "Monstres Masqu√©s",
        radarTitle: "Niveau de D√©duction",
        roadmapTitle: "Plan d'Enqu√™te",
        summaryTitle: "Et le coupable est...",
        icon: "üêï"
    },
    squidgame: {
        title: (name) => `üî∫ Strat√©gie de Survie pour ${name}`,
        swotTitle: "Analyse des √âpreuves",
        strengths: "Comp√©tences de Survie",
        weaknesses: "Points de Vuln√©rabilit√©",
        opportunities: "Alliances Strat√©giques",
        threats: "√âliminations Programm√©es",
        radarTitle: "Chances de Survie",
        roadmapTitle: "Plan des Jeux",
        summaryTitle: "Briefing du Front Man",
        icon: "üî∫"
    },
    pirates: {
        title: (name) => `üè¥‚Äç‚ò†Ô∏è Carte du Black Pearl pour ${name}`,
        swotTitle: "Analyse du Butin",
        strengths: "Votre √âquipage",
        weaknesses: "Mutineries Potentielles",
        opportunities: "Tr√©sors Cach√©s",
        threats: "La Flotte Royale",
        radarTitle: "Niveau de Piraterie",
        roadmapTitle: "Route vers le Tr√©sor",
        summaryTitle: "Conseil de Jack Sparrow",
        icon: "üè¥‚Äç‚ò†Ô∏è"
    },
    asterix: {
        title: (name) => `üçñ Plan du Village Gaulois pour ${name}`,
        swotTitle: "Analyse de la R√©sistance",
        strengths: "Potion Magique",
        weaknesses: "Stocks Limit√©s",
        opportunities: "Nouvelles Strat√©gies",
        threats: "L√©gions Romaines",
        radarTitle: "Niveau de R√©sistance",
        roadmapTitle: "Carte de la Gaule",
        summaryTitle: "Conseil de Panoramix",
        icon: "üçñ"
    },
    diddl: {
        title: (name) => `üê≠ Carnet Mignon pour ${name}`,
        swotTitle: "Analyse Kawaii",
        strengths: "Moments Doux",
        weaknesses: "Petits Soucis",
        opportunities: "Nouvelles Amiti√©s",
        threats: "Jours Difficiles",
        radarTitle: "Niveau de Bonheur",
        roadmapTitle: "Calendrier des C√¢lins",
        summaryTitle: "Message R√©confortant",
        icon: "üê≠"
    },
    dccomics: {
        title: (name) => `ü¶á Rapport de la Justice League pour ${name}`,
        swotTitle: "Analyse des Super-H√©ros",
        strengths: "Super-Pouvoirs Actifs",
        weaknesses: "Kryptonite Identifi√©e",
        opportunities: "Nouvelles Alliances",
        threats: "Ligues de Vilains",
        radarTitle: "Niveau H√©ro√Øque",
        roadmapTitle: "Plan de Sauvetage",
        summaryTitle: "Strat√©gie de Batman",
        icon: "ü¶á"
    },
    titanic: {
        title: (name) => `üö¢ Journal de Bord pour ${name}`,
        swotTitle: "Analyse du Voyage",
        strengths: "Ressources Embarqu√©es",
        weaknesses: "Icebergs √† l'Horizon",
        opportunities: "Nouvelles Routes",
        threats: "Dangers en Mer",
        radarTitle: "Niveau de Navigation",
        roadmapTitle: "Carte Maritime",
        summaryTitle: "Conseil du Capitaine",
        icon: "üö¢"
    },
    homealone: {
        title: (name) => `üè† Plan Anti-Cambrioleurs pour ${name}`,
        swotTitle: "Analyse des D√©fenses",
        strengths: "Pi√®ges Install√©s",
        weaknesses: "Zones Non S√©curis√©es",
        opportunities: "Nouveaux Gadgets",
        threats: "Bandits Persistants",
        radarTitle: "Niveau de Protection",
        roadmapTitle: "Plan de la Maison",
        summaryTitle: "Strat√©gie de Kevin",
        icon: "üè†"
    },
    assassin: {
        title: (name) => `üó°Ô∏è Codex de l'Assassin pour ${name}`,
        swotTitle: "Analyse de la Confr√©rie",
        strengths: "Techniques Secr√®tes",
        weaknesses: "Templiers Infiltr√©s",
        opportunities: "Nouveaux Alli√©s",
        threats: "L'Ordre des Templiers",
        radarTitle: "Niveau de Synchronisation",
        roadmapTitle: "Carte d'Animus",
        summaryTitle: "Credo de l'Assassin",
        icon: "üó°Ô∏è"
    }
};

function applyReportTheme(auditId) {
    const themeKey = document.getElementById('report-theme-selector').value;
    const theme = reportThemes[themeKey] || reportThemes.default;
    const audit = audits.find(a => a.id === auditId);
    
    document.getElementById('report-title').innerHTML = `${theme.icon} ${theme.title(escapeHtml(audit.clientInfo.businessName))}`;
    document.getElementById('summary-title').innerText = theme.summaryTitle;
    document.getElementById('swot-title').innerText = theme.swotTitle;
    document.getElementById('radar-title').innerText = theme.radarTitle;
    document.getElementById('roadmap-title').innerText = theme.roadmapTitle;

    document.querySelectorAll('.swot-strengths-title').forEach(el => el.innerText = theme.strengths);
    document.querySelectorAll('.swot-weaknesses-title').forEach(el => el.innerText = theme.weaknesses);
    document.querySelectorAll('.swot-opportunities-title').forEach(el => el.innerText = theme.opportunities);
    document.querySelectorAll('.swot-threats-title').forEach(el => el.innerText = theme.threats);
}

function renderRadarChart(auditId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    const canvas = document.getElementById('maturityRadar');
    if (!canvas) return;

    if (window.myRadarChart) {
        window.myRadarChart.destroy();
    }

    const labels = audit.personalizedAudit.phases.map(p => p.name);
    const data = audit.personalizedAudit.phases.map(p => {
        const phaseData = audit.phaseSWOTs[p.id];
        return (phaseData && phaseData.maturityScore) ? parseFloat(phaseData.maturityScore) : 0;
    });

    const ctx = canvas.getContext('2d');
    window.myRadarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Niveau de Maturit√©',
                data: data,
                fill: true,
                backgroundColor: 'rgba(255, 107, 107, 0.2)',
                borderColor: 'rgb(255, 107, 107)',
                pointBackgroundColor: 'rgb(255, 107, 107)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(255, 107, 107)'
            }]
        },
        options: {
            elements: {
                line: {
                    borderWidth: 3
                }
            },
            scales: {
                r: {
                    angleLines: { display: false },
                    suggestedMin: 0,
                    suggestedMax: 10,
                    pointLabels: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                       stepSize: 2
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

async function generateExecutiveSummary(auditId) {
    const loader = document.getElementById('summary-loader');
    const button = document.getElementById('generate-summary-btn');
    const summaryOutput = document.getElementById('executive-summary-output');
    
    loader.classList.remove('hidden');
    button.disabled = true;
    summaryOutput.innerHTML = '<p>T√©√ØLie est en train de pr√©parer sa meilleure plume...</p>';

    const audit = audits.find(a => a.id === auditId);
    if (!audit) {
        summaryOutput.innerHTML = '<p class="text-danger">Erreur: Audit non trouv√©.</p>';
        loader.classList.add('hidden');
        button.disabled = false;
        return;
    }

    let context = `CONTEXTE DE L'AUDIT:\n\n`;
    context += `Client: ${audit.clientInfo.firstName} ${audit.clientInfo.lastName}\n`;
    context += `Business: ${audit.clientInfo.businessName}\n`;
    context += `Objectifs Principaux: ${audit.clientInfo.priorityObjectives}\n`;
    context += `Probl√®mes Principaux: ${audit.clientInfo.mainProblems}\n\n`;
    context += `--- D√âTAILS DES PHASES DE L'AUDIT ---\n\n`;

    audit.personalizedAudit.phases.forEach(phase => {
        const phaseData = audit.phaseSWOTs[phase.id];
        if (phaseData && phaseData.swot) {
            context += `Phase: ${phase.name}\n`;
            context += `Forces: ${phaseData.swot.strengths}\n`;
            context += `Faiblesses: ${phaseData.swot.weaknesses}\n`;
            context += `Opportunit√©s: ${phaseData.swot.opportunities}\n`;
            context += `Menaces: ${phaseData.swot.threats}\n\n`;
        }
    });

    const prompt = `Agis comme une COO de g√©nie, directe, bienveillante et anti-bullshit. Lis l'int√©gralit√© de cet audit et r√©dige un r√©sum√© ex√©cutif percutant de 3 paragraphes pour le CEO : 
1/ La situation actuelle et les risques, en √©tant cash mais encourageant. 
2/ Les opportunit√©s cl√©s identifi√©es pour d√©bloquer la situation. 
3/ Les 3 premi√®res actions concr√®tes de la roadmap pour des r√©sultats rapides ("quick wins").
Le ton doit √™tre direct, confiant et donner envie de passer √† l'action. Adresse-toi directement au CEO (utilise "tu" et "ton").

Voici les donn√©es de l'audit:\n${context}`;

    try {
        const model = document.getElementById('ai-selector-report')?.value || 'gemini';
        const result = await callAI(model, prompt);
        
        if (result && result.text) {
             summaryOutput.innerHTML = result.text.replace(/\n/g, '<br>');
        } else {
            summaryOutput.innerHTML = "<p class='text-danger'>T√©√ØLie semble avoir un blocage de l'√©crivain. R√©essayez.</p>";
        }
    } catch(e) {
        summaryOutput.innerHTML = `<p class="text-danger">Erreur de communication avec T√©√ØLie: ${e.message}</p>`;
    } finally {
        loader.classList.add('hidden');
        button.disabled = false;
    }
}

function renderCalendarView(calendarData) {
    if (!calendarData || (typeof calendarData === 'string' && (calendarData.trim() === '' || calendarData.trim() === 'Non renseign√©.')) || (typeof calendarData === 'object' && Object.keys(calendarData).length === 0)) {
        return '<p class="muted">Aucune donn√©e de calendrier √† afficher.</p>';
    }

    if (typeof calendarData === 'object' && !Array.isArray(calendarData) && calendarData !== null) {
        const dayOrder = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        const timeSlots = { matin: 'Matin', midi: 'Midi', aprem: 'Apr√®s-midi', soir: 'Soir√©e' };

        let html = '<div class="calendar-grid">';
        let hasContent = false;
        dayOrder.forEach(day => {
            const dayData = calendarData[day];
            const dayHasContent = dayData && Object.values(dayData).some(v => v && v.trim() !== '');

            if (dayHasContent) {
                hasContent = true;
                html += `<div class="calendar-day"><h4>${day}</h4>`;
                for (const slotId in timeSlots) {
                    if (dayData[slotId] && dayData[slotId].trim() !== '') {
                        const blockText = dayData[slotId];
                        let blockClass = 'block-default';
                        const lowerLine = blockText.toLowerCase();
                        if (lowerLine.includes('strat√©gie') || lowerLine.includes('vision')) blockClass = 'block-strat';
                        else if (lowerLine.includes('client') || lowerLine.includes('call')) blockClass = 'block-client';
                        else if (lowerLine.includes('off') || lowerLine.includes('perso')) blockClass = 'block-off';
                        else if (lowerLine.includes('admin') || lowerLine.includes('email')) blockClass = 'block-admin';
                        
                        const activities = blockText.split('\n').filter(a => a.trim() !== '');
                        activities.forEach(activity => {
                             html += `<div class="calendar-block ${blockClass}">${escapeHtml(activity)}</div>`;
                        });
                    }
                }
                html += `</div>`;
            }
        });
        html += '</div>';

        return hasContent ? html : '<p class="muted">Aucune donn√©e de calendrier √† afficher.</p>';
    }

    if (typeof calendarData === 'string') {
        const lines = calendarData.split('\n').filter(l => l.trim() !== '');
        const days = { Lundi: [], Mardi: [], Mercredi: [], Jeudi: [], Vendredi: [], Samedi: [], Dimanche: [] };
        const dayOrder = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        let currentDay = null;

        lines.forEach(line => {
            const dayMatch = line.match(/^(Lundi|Mardi|Mercredi|Jeudi|Vendredi|Samedi|Dimanche)/i);
            if (dayMatch) {
                currentDay = dayOrder.find(d => d.toLowerCase() === dayMatch[0].toLowerCase().replace(':', ''));
            }
            if (currentDay) {
                let blockClass = 'block-default';
                const lowerLine = line.toLowerCase();
                if (lowerLine.includes('strat√©gie') || lowerLine.includes('vision')) blockClass = 'block-strat';
                else if (lowerLine.includes('client') || lowerLine.includes('call')) blockClass = 'block-client';
                else if (lowerLine.includes('off') || lowerLine.includes('perso')) blockClass = 'block-off';
                else if (lowerLine.includes('admin') || lowerLine.includes('email')) blockClass = 'block-admin';

                days[currentDay].push(`<div class="calendar-block ${blockClass}">${escapeHtml(line)}</div>`);
            }
        });

        let html = '<div class="calendar-grid">';
        let hasContent = false;
        dayOrder.forEach(day => {
            if (days[day].length > 0) {
                hasContent = true;
                html += `
                    <div class="calendar-day">
                        <h4>${day}</h4>
                        ${days[day].join('')}
                    </div>
                `;
            }
        });
        html += '</div>';
        
        if (!hasContent) {
            return `<div class="content-section" style="background: var(--bg-secondary);"><pre>${escapeHtml(calendarData)}</pre></div>`;
        }

        return html;
    }
    
    return '<p class="muted">Format de donn√©es de calendrier non reconnu.</p>';
}

function renderJourneyMapView(journeyData, title) {
    if (!journeyData || Object.keys(journeyData).length === 0) {
        return `<div class="content-section" style="border-top: 4px solid var(--p2); padding: 10px;"><h4>${title}</h4><p class="muted">Aucune donn√©e de parcours client √† afficher.</p></div>`;
    }

    const steps = ['D√©couverte', 'Int√©r√™t', 'Consid√©ration', 'D√©cision', 'Achat', 'Fid√©lisation'];
    let html = `
        <div>
            <h4>${title}</h4>
            <div class="journey-map-container">
                <div class="journey-map">
    `;

    steps.forEach((stepName, index) => {
        const stepData = journeyData[index] || {};
        html += `
            <div class="journey-step">
                <h4>${stepName}</h4>
                <p><strong>Action :</strong> ${escapeHtml(stepData.action || 'N/A')}</p>
                <p><strong>Intervenant :</strong> ${escapeHtml(stepData.intervenant || 'N/A')}</p>
                <p><strong>Outils :</strong> ${escapeHtml(stepData.outils || 'N/A')}</p>
                <p><strong>KPIs :</strong> ${escapeHtml(stepData.kpis || 'N/A')}</p>
            </div>
        `;
    });

    html += `
                </div>
            </div>
        </div>
    `;
    return html;
}

function generateFinalSynthesis(auditId){
    currentAuditId = auditId;
    const audit = audits.find(a => a.id === auditId); if(!audit) return;
    hideAllSections();

    const el = document.createElement('div');
    el.innerHTML = renderNavigation(auditId, 'report');
    
    let themeOptionsHTML = '';
    for (const key in reportThemes) {
        themeOptionsHTML += `<option value="${key}">${reportThemes[key].icon} ${reportThemes[key].title('').trim()}</option>`;
    }

    const swotSectionsHTML = audit.personalizedAudit.phases.map(phase => {
        const phaseData = audit.phaseSWOTs[phase.id];
        if (!phaseData || !phaseData.swot) return '';
        return `
            <div class="report-section">
                <h3>${escapeHtml(phase.name)} (Maturit√©: ${phaseData.maturityScore || 'N/A'}/10)</h3>
                <div class="report-swot">
                    <div><h4 class="swot-strengths-title">Forces</h4><ul>${phaseData.swot.strengths.split('\n').map(s => s.trim() && `<li>${escapeHtml(s)}</li>`).join('')}</ul></div>
                    <div><h4 class="swot-weaknesses-title">Faiblesses</h4><ul>${phaseData.swot.weaknesses.split('\n').map(s => s.trim() && `<li>${escapeHtml(s)}</li>`).join('')}</ul></div>
                    <div><h4 class="swot-opportunities-title">Opportunit√©s</h4><ul>${phaseData.swot.opportunities.split('\n').map(s => s.trim() && `<li>${escapeHtml(s)}</li>`).join('')}</ul></div>
                    <div><h4 class="swot-threats-title">Menaces</h4><ul>${phaseData.swot.threats.split('\n').map(s => s.trim() && `<li>${escapeHtml(s)}</li>`).join('')}</ul></div>
                </div>
            </div>
        `;
    }).join('');
    
    const roadmapItems = audit.personalizedAudit.phases.flatMap(phase => 
        (audit.phaseSWOTs[phase.id]?.swot?.opportunities || '').split('\n').filter(o => o.trim())
    );
    const roadmapHTML = `<ul>${roadmapItems.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>`;

    const calendarBeforeData = audit.phaseSWOTs['organization']?.responses?.orga_calendrier_actuel || {};
    const calendarAfterData = audit.entryData.q_semaine_ideale || 'Non renseign√©.';
    const calendarBeforeHTML = renderCalendarView(calendarBeforeData);
    const calendarOptimizedHTML = `<div class="calendar-grid"><div class="calendar-day" style="justify-content:center; align-items:center; display:flex; flex-direction:column; text-align:center;"><p>ü§ñ</p><p>L'agenda optimis√© sera g√©n√©r√© ici par T√©√ØLie, en mixant le meilleur de l'agenda actuel avec les objectifs de la semaine id√©ale.</p></div></div>`;
    const calendarAfterHTML = renderCalendarView(calendarAfterData);

    const offerData = audit.phaseSWOTs['offers']?.responses?.offers_detailed_table || [];
    let journeyHTML = '<p class="muted">Aucune donn√©e d\'offre trouv√©e pour g√©n√©rer le parcours client.</p>';

    if (offerData.length > 0) {
        const mainOfferName = offerData[0].nom_offre || "Offre Principale";
        let parcoursData = {};
        if(audit.phaseSWOTs['offers']?.responses?.parcours_client){
             parcoursData = audit.phaseSWOTs['offers'].responses.parcours_client[mainOfferName] || {};
        }

        const journeyCurrentHTML = renderJourneyMapView(parcoursData, `Parcours Actuel (${escapeHtml(mainOfferName)})`);
        const journeyOptimizedHTML = renderJourneyMapView({}, `Parcours Optimis√©`);
        const journeyObjectiveHTML = renderJourneyMapView({}, `Parcours Cible`);

        journeyHTML = `<div class="grid grid-3">${journeyCurrentHTML}${journeyOptimizedHTML}${journeyObjectiveHTML}</div>`;
    }

    const worksOnVacation = audit.phaseSWOTs['organization']?.responses?.orga_vacances_travail === 'oui';
    const vacationAgendaText = audit.phaseSWOTs['organization']?.responses?.orga_vacances_organisation || '';

    const checklistHTML = `
        <h4>Checklist de D√©part</h4>
        <ul>
            <li>‚úÖ D√©finir et communiquer les dates d'absence √† l'√©quipe et aux clients.</li>
            <li>‚úÖ Activer le message d'absence automatique (email, Slack...).</li>
            <li>‚úÖ Attribuer un "gardien du temple" (point de contact principal) pour l'√©quipe.</li>
            <li>‚úÖ Lister les urgences potentielles et les protocoles associ√©s.</li>
            <li>‚úÖ S'assurer que les mots de passe importants sont accessibles (via un gestionnaire s√©curis√©).</li>
            <li>‚úÖ Planifier une r√©union de "passage de relais" avant le d√©part.</li>
            <li>‚úÖ Planifier une r√©union de "reprise" pour le retour.</li>
            <li>‚úÖ Couper les notifications sur le t√©l√©phone personnel.</li>
        </ul>
    `;

    let vacationHTML = '';
    if (worksOnVacation) {
        const timeZoneGuideHTML = `
            <h4>Guide de Gestion du Fuseau Horaire</h4>
            <p class="small">Si tu travailles depuis l'autre bout du monde :</p>
            <ul>
                <li><strong>D√©finis 1-2h de "bureau" fixes</strong> sur le fuseau de ton √©quipe et respecte-les.</li>
                <li><strong>Utilise un planificateur d'appels</strong> (ex: Calendly) qui g√®re les fuseaux.</li>
                <li><strong>Communique tes horaires de travail</strong> clairement √† ton √©quipe.</li>
                <li><strong>Privil√©gie la communication asynchrone</strong> (Loom, messages vocaux) pour √©viter les attentes.</li>
            </ul>
        `;
        const vacationAgendaHTML = renderCalendarView(vacationAgendaText);
        vacationHTML = `
            <div class="report-section">
                <h2>üå¥ Plan de Bataille pour des Vacances (Presque) OFF</h2>
                <div class="grid grid-2">
                    <div>
                        <h4>Agenda Sp√©cial Vacances</h4>
                        ${vacationAgendaHTML}
                    </div>
                    <div>
                        ${checklistHTML}
                        ${timeZoneGuideHTML}
                    </div>
                </div>
            </div>
        `;
    } else {
         vacationHTML = `
            <div class="report-section">
                <h2>üå¥ Pr√©paration pour une D√©connexion Totale</h2>
                ${checklistHTML}
            </div>
        `;
    }

    const content = document.createElement('div');
    content.className = 'content-section';
    content.innerHTML = `
        <div class="no-print" style="background: var(--bg-secondary); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
            <div>
                <label for="report-theme-selector" style="font-weight: 600; margin-right: 10px;">Th√®me du rapport :</label>
                <select id="report-theme-selector" onchange="applyReportTheme('${auditId}')" class="btn-sm" style="padding: 8px 12px; border: 1px solid var(--border-color);">
                    ${themeOptionsHTML}
                </select>
            </div>
            <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
        </div>

        <div id="report-view">
            <div class="report-header">
                <h1 id="report-title"></h1>
                <p>Pr√©par√© pour ${escapeHtml(audit.clientInfo.firstName)} ${escapeHtml(audit.clientInfo.lastName)}</p>
                <p class="small">Date: ${new Date().toLocaleDateString('fr-FR')}</p>
            </div>

            <div class="report-section">
                <h2 id="summary-title">R√©sum√© Ex√©cutif</h2>
                <div class="no-print" style="margin-bottom: 15px; text-align: center;">
                     <select id="ai-selector-report" class="btn-sm" style="padding: 8px 12px; border: 1px solid var(--border-color); color: var(--text-dark);">
                        <option value="gemini">T√©√ØLie (Gemini - √âquilibr√©)</option>
                        <option value="claude">T√©√ØLie (Claude - Analytique)</option>
                        <option value="chatgpt">T√©√ØLie (ChatGPT - Cr√©atif)</option>
                    </select>
                    <button id="generate-summary-btn" class="btn btn-info" onclick="generateExecutiveSummary('${auditId}')">
                        ü§ñ R√©diger le r√©sum√© pour le CEO <span id="summary-loader" class="loader hidden"></span>
                    </button>
                </div>
                <div id="executive-summary-output" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; min-height: 100px;">
                    <p class="muted">Cliquez sur le bouton ci-dessus pour g√©n√©rer le r√©sum√© avec l'aide de T√©√ØLie.</p>
                </div>
            </div>

            <div class="report-section">
                <h2 id="radar-title">Radar de Maturit√©</h2>
                <div style="height: 450px; position: relative;">
                    <canvas id="maturityRadar"></canvas>
                </div>
            </div>
            
            <div class="report-section">
                <h2>üóìÔ∏è Transformation du Calendrier (3 √©tapes)</h2>
                <div class="grid grid-3">
                    <div>
                        <h3>Actuel</h3>
                        ${calendarBeforeHTML}
                    </div>
                    <div>
                        <h3>Actuel Optimis√©</h3>
                        ${calendarOptimizedHTML}
                    </div>
                    <div>
                        <h3>Objectif</h3>
                        ${calendarAfterHTML}
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h2>üó∫Ô∏è √âvolution du Parcours Client</h2>
                ${journeyHTML}
            </div>

            ${vacationHTML}

            <div class="report-section">
                <h2 id="swot-title">Analyse SWOT Synth√©tique</h2>
                ${swotSectionsHTML}
            </div>
            
            <div class="report-section">
                <h2 id="roadmap-title">Feuille de Route Recommand√©e</h2>
                ${roadmapHTML}
            </div>
        </div>
    `;

    el.appendChild(content);
    $app.appendChild(el);
    
    // D√©tection automatique intelligente du th√®me bas√© sur la r√©f√©rence pop culture
const popCulture = (audit.clientInfo.favoritePopCulture || '').toLowerCase();
const selector = document.getElementById('report-theme-selector');

if (popCulture.includes('potter') || popCulture.includes('harry')) {
    selector.value = 'harryPotter';
} else if (popCulture.includes('marvel') || popCulture.includes('stark') || popCulture.includes('avengers') || popCulture.includes('iron man') || popCulture.includes('spider')) {
    selector.value = 'marvel';
} else if (popCulture.includes('star wars') || popCulture.includes('jedi') || popCulture.includes('skywalker') || popCulture.includes('mandalorian')) {
    selector.value = 'starWars';
} else if (popCulture.includes('mario') || popCulture.includes('peach') || popCulture.includes('bowser')) {
    selector.value = 'mario';
} else if (popCulture.includes('zelda') || popCulture.includes('link') || popCulture.includes('hyrule') || popCulture.includes('ganon')) {
    selector.value = 'zelda';
} else if (popCulture.includes('pokemon') || popCulture.includes('pok√©mon') || popCulture.includes('pikachu') || popCulture.includes('sacha')) {
    selector.value = 'pokemon';
} else if (popCulture.includes('seigneur') || popCulture.includes('lotr') || popCulture.includes('anneau') || popCulture.includes('hobbit') || popCulture.includes('gandalf') || popCulture.includes('frodon')) {
    selector.value = 'lotr';
} else if (popCulture.includes('matrix') || popCulture.includes('neo') || popCulture.includes('morpheus')) {
    selector.value = 'matrix';
} else if (popCulture.includes('game of thrones') || popCulture.includes('got') || popCulture.includes('tr√¥ne') || popCulture.includes('westeros') || popCulture.includes('stark') || popCulture.includes('lannister')) {
    selector.value = 'got';
} else if (popCulture.includes('friends') || popCulture.includes('central perk') || popCulture.includes('monica') || popCulture.includes('chandler')) {
    selector.value = 'friends';
} else if (popCulture.includes('disney') || popCulture.includes('pixar') || popCulture.includes('cendrillon') || popCulture.includes('reine des neiges')) {
    selector.value = 'disney';
} else if (popCulture.includes('grease') || popCulture.includes('pink ladies') || popCulture.includes('t-birds')) {
    selector.value = 'grease';
} else if (popCulture.includes('dragon ball') || popCulture.includes('dbz') || popCulture.includes('goku') || popCulture.includes('kamehameha')) {
    selector.value = 'dragonball';
} else if (popCulture.includes('naruto') || popCulture.includes('konoha') || popCulture.includes('hokage') || popCulture.includes('sasuke')) {
    selector.value = 'naruto';
} else if (popCulture.includes('one piece') || popCulture.includes('luffy') || popCulture.includes('mugiwara') || popCulture.includes('chapeau de paille')) {
    selector.value = 'onepiece';
} else if (popCulture.includes('sonic') || popCulture.includes('tails') || popCulture.includes('robotnik') || popCulture.includes('eggman')) {
    selector.value = 'sonic';
} else if (popCulture.includes('pac-man') || popCulture.includes('pacman') || popCulture.includes('pac man')) {
    selector.value = 'pacman';
} else if (popCulture.includes('charmed') || popCulture.includes('halliwell') || popCulture.includes('pouvoir des trois')) {
    selector.value = 'charmed';
} else if (popCulture.includes('buffy') || popCulture.includes('tueuse') || popCulture.includes('sunnydale')) {
    selector.value = 'buffy';
} else if (popCulture.includes('panth√®re rose') || popCulture.includes('panthere rose') || popCulture.includes('pink panther')) {
    selector.value = 'panthere';
} else if (popCulture.includes('call of duty') || popCulture.includes('cod') || popCulture.includes('modern warfare')) {
    selector.value = 'cod';
} else if (popCulture.includes('lara croft') || popCulture.includes('tomb raider')) {
    selector.value = 'laracroft';
} else if (popCulture.includes('sims') || popCulture.includes('les sims')) {
    selector.value = 'sims';
} else if (popCulture.includes('scooby') || popCulture.includes('scoubidou') || popCulture.includes('mystery machine')) {
    selector.value = 'scoobydoo';
} else if (popCulture.includes('squid game') || popCulture.includes('squidgame')) {
    selector.value = 'squidgame';
} else if (popCulture.includes('pirates') || popCulture.includes('cara√Øbes') || popCulture.includes('caribbean') || popCulture.includes('jack sparrow')) {
    selector.value = 'pirates';
} else if (popCulture.includes('ast√©rix') || popCulture.includes('asterix') || popCulture.includes('ob√©lix') || popCulture.includes('obelix')) {
    selector.value = 'asterix';
} else if (popCulture.includes('diddl')) {
    selector.value = 'diddl';
} else if (popCulture.includes('dc comics') || popCulture.includes('batman') || popCulture.includes('superman') || popCulture.includes('justice league')) {
    selector.value = 'dccomics';
} else if (popCulture.includes('titanic')) {
    selector.value = 'titanic';
} else if (popCulture.includes('maman') || popCulture.includes('home alone') || popCulture.includes('kevin')) {
    selector.value = 'homealone';
} else if (popCulture.includes('assassin') || popCulture.includes('creed') || popCulture.includes('ezio')) {
    selector.value = 'assassin';
}

applyReportTheme(auditId);
    renderRadarChart(auditId);
}

/* ============================
  AI Integration
============================ */

async function generateAllProductivityAvis(auditId, phaseId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    const loader = document.getElementById('generate_productivity_avis_loader');
    const button = document.getElementById('generate_productivity_avis');
    
    if (loader) loader.classList.remove('hidden');
    if (button) button.disabled = true;
    
    try {
        const tableEl = document.getElementById('table-widget-productivity_table');
        if (!tableEl) return;
        
        const rows = tableEl.querySelectorAll('tbody tr');
        
        for (let row of rows) {
            const tache = row.querySelector('[data-col-id="tache"]')?.value || '';
            const heures = row.querySelector('[data-col-id="heures"]')?.value || '';
            const plaisir = row.querySelector('[data-col-id="plaisir"]')?.value || '';
            const competence = row.querySelector('[data-col-id="competence"]')?.value || '';
            const statut = row.querySelector('[data-col-id="statut"]')?.value || '';
            
            if (tache) {
                const prompt = `En tant que COO expert en syst√©matisation, analyse cette t√¢che et donne un avis ultra-concret sur comment la syst√©matiser/optimiser :
                T√¢che: ${tache}
                Temps/semaine: ${heures}h
                Plaisir: ${plaisir}
                Comp√©tence: ${competence}
                Statut actuel: ${statut}
                
                Donne UN SEUL conseil actionnable en 1-2 phrases max. Sois direct et pratique.`;
                
                try {
                    const result = await callAI('gemini', prompt);
                    if (result && result.text) {
                        const avisTextarea = row.querySelector('[data-col-id="avis_systematisation"]');
                        if (avisTextarea) {
                            avisTextarea.value = result.text;
                        }
                    }
                } catch(e) {
                    console.error('Erreur IA pour la t√¢che:', tache, e);
                }
            }
        }
        
        showAutoSaveFeedback();
    } finally {
        if (loader) loader.classList.add('hidden');
        if (button) button.disabled = false;
    }
}

async function generateAllOfferActions(auditId, phaseId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    const loader = document.getElementById('generate_offer_recommendations_loader');
    const button = document.getElementById('generate_offer_recommendations');
    
    if (loader) loader.classList.remove('hidden');
    if (button) button.disabled = true;
    
    try {
        const tableEl = document.getElementById('table-widget-offers_detailed_table');
        if (!tableEl) return;
        
        const rows = tableEl.querySelectorAll('tbody tr');
        
        for (let row of rows) {
            const nom = row.querySelector('[data-col-id="nom_offre"]')?.value || '';
            const prix = row.querySelector('[data-col-id="prix"]')?.value || '';
            const ventes = row.querySelector('[data-col-id="nb_ventes_12mois"]')?.value || '';
            const marge = row.querySelector('[data-col-id="marge_nette"]')?.innerText || '';
            const scalable = row.querySelector('[data-col-id="scalable"]')?.value || '';
            const objectif = row.querySelector('[data-col-id="objectif"]')?.value || '';
            
            if (nom) {
                const prompt = `En tant que strat√®ge business, analyse cette offre et donne 2-3 actions concr√®tes :
                Offre: ${nom}
                Prix: ${prix}‚Ç¨
                Ventes 12 mois: ${ventes}
                Marge: ${marge}
                Scalable: ${scalable}
                Objectif: ${objectif}
                
                Donne 2-3 actions ULTRA-CONCR√àTES pour optimiser cette offre. Sois direct et actionnable.`;
                
                try {
                    const result = await callAI('gemini', prompt);
                    if (result && result.text) {
                        const actionsTextarea = row.querySelector('[data-col-id="avis_actions"]');
                        if (actionsTextarea) {
                            actionsTextarea.value = result.text;
                        }
                    }
                } catch(e) {
                    console.error('Erreur IA pour l\'offre:', nom, e);
                }
            }
        }
        
        showAutoSaveFeedback();
    } finally {
        if (loader) loader.classList.add('hidden');
        if (button) button.disabled = false;
    }
}

async function generateSwotWithAI(auditId, phaseId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    const loader = document.getElementById('swot-loader');
    loader.classList.remove('hidden');
    
    const phase = audit.personalizedAudit.phases.find(p => p.id === phaseId);
    if (!phase) return;
    
    const responses = {};
    phase.questions.forEach(q => {
        if (q.type === 'table') {
            const tableEl = document.getElementById(`table-widget-${q.id}`);
            if (tableEl) {
                const tableData = [];
                tableEl.querySelectorAll('tbody tr').forEach(row => {
                    const rowData = {};
                    q.columns.forEach(col => {
                        if (col.type !== 'calculated' && col.type !== 'calculated_margin') {
                            const input = row.querySelector(`[data-col-id="${col.id}"]`);
                            if (input) rowData[col.id] = input.value;
                        }
                    });
                    tableData.push(rowData);
                });
                responses[q.text] = JSON.stringify(tableData);
            }
        } else if (q.type !== 'ai_button' && q.type !== 'subheading') {
            const el = document.getElementById(q.id);
            if (el) responses[q.text] = el.value;
        }
    });
    
    const prompt = `Analyse ces donn√©es de la phase "${phase.name}" et g√©n√®re une analyse SWOT compl√®te.
    
    Donn√©es collect√©es:
    ${JSON.stringify(responses, null, 2)}
    
    G√©n√®re une analyse SWOT avec:
    - 3-4 Forces (points forts actuels)
    - 3-4 Faiblesses (points √† am√©liorer)
    - 3-4 Opportunit√©s (potentiels de croissance)
    - 3-4 Menaces (risques √† anticiper)
    
    Format: une ligne par point, sois concret et sp√©cifique au contexte.`;
    
    try {
        const model = document.getElementById('ai-selector')?.value || 'gemini';
        const result = await callAI(model, prompt);
        
        if (result && result.text) {
            if (!audit.phaseSWOTs[phaseId]) audit.phaseSWOTs[phaseId] = {};
            audit.phaseSWOTs[phaseId].swotDraft = result.text;
            saveAudits();
            
            const lines = result.text.split('\n');
            let currentSection = '';
            let strengths = [], weaknesses = [], opportunities = [], threats = [];
            
            lines.forEach(line => {
                const lower = line.toLowerCase();
                if (lower.includes('force')) currentSection = 'strengths';
                else if (lower.includes('faiblesse')) currentSection = 'weaknesses';
                else if (lower.includes('opportunit√©')) currentSection = 'opportunities';
                else if (lower.includes('menace')) currentSection = 'threats';
                else if (line.trim() && currentSection) {
                    const cleanLine = line.replace(/^[-‚Ä¢*]\s*/, '').trim();
                    if (cleanLine && !cleanLine.includes(':')) {
                        if (currentSection === 'strengths') strengths.push(cleanLine);
                        else if (currentSection === 'weaknesses') weaknesses.push(cleanLine);
                        else if (currentSection === 'opportunities') opportunities.push(cleanLine);
                        else if (currentSection === 'threats') threats.push(cleanLine);
                    }
                }
            });
            
            document.getElementById('swot_strengths').value = strengths.join('\n');
            document.getElementById('swot_weaknesses').value = weaknesses.join('\n');
            document.getElementById('swot_opportunities').value = opportunities.join('\n');
            document.getElementById('swot_threats').value = threats.join('\n');
            
            showSwotBrainstorm(auditId, phaseId);
        }
    } catch(e) {
        showInfoModal('Erreur IA', `Impossible de g√©n√©rer le SWOT: ${e.message}`);
    } finally {
        loader.classList.add('hidden');
    }
}

function showSwotBrainstorm(auditId, phaseId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    if (!audit.phaseSWOTs[phaseId]) audit.phaseSWOTs[phaseId] = {};
    if (!audit.phaseSWOTs[phaseId].swotBrainstorm) {
        audit.phaseSWOTs[phaseId].swotBrainstorm = [];
    }
    
    const swotContainer = document.querySelector('.content-section:has(#swot_strengths)');
    if (!swotContainer) return;
    
    let brainstormZone = document.getElementById('swot-brainstorm-zone');
    if (!brainstormZone) {
        brainstormZone = document.createElement('div');
        brainstormZone.id = 'swot-brainstorm-zone';
        brainstormZone.style.cssText = 'margin-top: 20px; background: var(--bg-secondary); padding: 20px; border-radius: 12px;';
        swotContainer.insertBefore(brainstormZone, document.getElementById('maturity-score').closest('.form-group'));
    }
    
    brainstormZone.innerHTML = `
        <h4 style="margin-bottom: 15px;">üí¨ Affiner ce SWOT avec T√©√ØLie</h4>
        <p class="muted small" style="margin-bottom: 15px;">Discute avec T√©√ØLie pour am√©liorer l'analyse avant validation finale.</p>
        
        <div id="swot-chat" style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; min-height: 250px; max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
            ${renderSwotBrainstormHistory(audit.phaseSWOTs[phaseId].swotBrainstorm)}
        </div>
        
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="swot-brainstorm-input" 
                      placeholder="Ex: Peux-tu d√©velopper la force n¬∞2 ? / Cette menace me semble exag√©r√©e / Ajoute une opportunit√© sur l'automatisation"
                      style="flex: 1; min-height: 60px; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); resize: vertical;"></textarea>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn btn-info btn-sm" onclick="sendSwotBrainstormMessage('${auditId}', '${phaseId}')">
                    Envoyer <span id="swot-brainstorm-loader" class="loader hidden"></span>
                </button>
                <button class="btn btn-success btn-sm" onclick="validateFinalSwot('${auditId}', '${phaseId}')">
                    ‚úÖ Valider
                </button>
            </div>
        </div>
    `;
    
    brainstormZone.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    document.getElementById('swot-brainstorm-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            sendSwotBrainstormMessage(auditId, phaseId);
        }
    });
}

function renderSwotBrainstormHistory(history) {
    if (!history || history.length === 0) {
        return `<div style="text-align: center; color: #999; padding: 20px;">
            <p>Pose une question ou demande une modification √† T√©√ØLie</p>
            <p class="small" style="margin-top: 5px;">Ctrl + Entr√©e pour envoyer</p>
        </div>`;
    }
    
    return history.map(msg => {
        const isUser = msg.role === 'user';
        const bgColor = isUser ? '#f8f9fa' : '#e3f2fd';
        const name = isUser ? 'Toi' : 'T√©√ØLie';
        
        return `
            <div style="margin-bottom: 15px; padding: 10px; background: ${bgColor}; border-radius: 8px;">
                <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; color: var(--g1);">
                    ${name}
                </div>
                <div style="font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap;">${escapeHtml(msg.content)}</div>
            </div>
        `;
    }).join('');
}

window.sendSwotBrainstormMessage = async function(auditId, phaseId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    const input = document.getElementById('swot-brainstorm-input');
    const loader = document.getElementById('swot-brainstorm-loader');
    const chat = document.getElementById('swot-chat');
    const message = input.value.trim();
    
    if (!message) return;
    
    if (!audit.phaseSWOTs[phaseId].swotBrainstorm) {
        audit.phaseSWOTs[phaseId].swotBrainstorm = [];
    }
    audit.phaseSWOTs[phaseId].swotBrainstorm.push({
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
    });
    
    input.value = '';
    loader.classList.remove('hidden');
    input.disabled = true;
    
    chat.innerHTML = renderSwotBrainstormHistory(audit.phaseSWOTs[phaseId].swotBrainstorm);
    chat.scrollTop = chat.scrollHeight;
    
    try {
        const currentSwot = `
Forces actuelles:
${document.getElementById('swot_strengths').value}

Faiblesses actuelles:
${document.getElementById('swot_weaknesses').value}

Opportunit√©s actuelles:
${document.getElementById('swot_opportunities').value}

Menaces actuelles:
${document.getElementById('swot_threats').value}
`;
        
        const context = `Tu es T√©√ØLie, COO experte qui affine un SWOT avec ${audit.clientInfo.firstName}.

SWOT actuel:
${currentSwot}

Demande de ${audit.clientInfo.firstName}: ${message}

R√©ponds de mani√®re concise et actionnable. Si on te demande de modifier le SWOT, propose les nouvelles formulations exactes √† utiliser.`;
        
        const model = document.getElementById('ai-selector')?.value || 'gemini';
        const result = await callAI(model, context);
        
        if (result && result.text) {
            audit.phaseSWOTs[phaseId].swotBrainstorm.push({
                role: 'assistant',
                content: result.text,
                timestamp: new Date().toISOString()
            });
            
            saveAudits();
            chat.innerHTML = renderSwotBrainstormHistory(audit.phaseSWOTs[phaseId].swotBrainstorm);
            chat.scrollTop = chat.scrollHeight;
        }
    } catch (e) {
        audit.phaseSWOTs[phaseId].swotBrainstorm.push({
            role: 'assistant',
            content: `Erreur: ${e.message}`,
            timestamp: new Date().toISOString()
        });
        chat.innerHTML = renderSwotBrainstormHistory(audit.phaseSWOTs[phaseId].swotBrainstorm);
    } finally {
        loader.classList.add('hidden');
        input.disabled = false;
        input.focus();
    }
};

window.validateFinalSwot = function(auditId, phaseId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    const swot = {
        strengths: document.getElementById('swot_strengths').value,
        weaknesses: document.getElementById('swot_weaknesses').value,
        opportunities: document.getElementById('swot_opportunities').value,
        threats: document.getElementById('swot_threats').value
    };
    
    if (!swot.strengths || !swot.weaknesses || !swot.opportunities || !swot.threats) {
        alert('Veuillez remplir toutes les sections du SWOT avant de valider.');
        return;
    }
    
    if (!audit.phaseSWOTs[phaseId]) audit.phaseSWOTs[phaseId] = {};
    audit.phaseSWOTs[phaseId].swot = swot;
    audit.phaseSWOTs[phaseId].swotValidated = true;
    audit.lastModified = new Date().toISOString();
    saveAudits();
    
    const brainstormZone = document.getElementById('swot-brainstorm-zone');
    if (brainstormZone) {
        brainstormZone.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--ok);">
                <h4>‚úÖ SWOT valid√© et enregistr√© !</h4>
                <p class="muted">Vous pouvez maintenant enregistrer cette phase et continuer.</p>
                <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="showSwotBrainstorm('${auditId}', '${phaseId}')">
                    Rouvrir la discussion
                </button>
            </div>
        `;
    }
    
    showAutoSaveFeedback();
};

async function generateAngleMort(auditId, phaseId) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    const loader = document.getElementById('blindspot-loader');
    loader.classList.remove('hidden');
    
    const swot = {
        strengths: document.getElementById('swot_strengths')?.value || '',
        weaknesses: document.getElementById('swot_weaknesses')?.value || '',
        opportunities: document.getElementById('swot_opportunities')?.value || '',
        threats: document.getElementById('swot_threats')?.value || ''
    };
    
    const prompt = `En analysant ce SWOT, identifie l'ANGLE MORT - ce que le CEO ne voit probablement pas mais qui pourrait tout changer :
    
    Forces: ${swot.strengths}
    Faiblesses: ${swot.weaknesses}
    Opportunit√©s: ${swot.opportunities}
    Menaces: ${swot.threats}
    
    Donne UN SEUL insight percutant qui n'est pas √©vident dans le SWOT mais qui pourrait √™tre crucial. Sois direct et impactant en 2-3 phrases max.`;
    
    try {
        const result = await callAI('gemini', prompt);
        if (result && result.text) {
            showInfoModal('üéØ L\'Angle Mort Identifi√©', `<p><strong>${result.text}</strong></p>`);
        }
    } catch(e) {
        showInfoModal('Erreur', 'Impossible d\'identifier l\'angle mort.');
    } finally {
        loader.classList.add('hidden');
    }
}

async function callAI(model, userQuery, responseSchema) {
    console.log(`--- Appel √† T√©√ØLie (moteur: ${model}) ---`);
    
    try {
        const isLocalFile = window.location.protocol === 'file:';
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        if (isLocalFile && !isLocalhost) {
            console.log('Mode simulation (fichier local)');
            return {
                text: generateMockResponse(userQuery)
            };
        }
        
        console.log('Tentative d\'appel √† l\'API Netlify...');
        const response = await fetch('/.netlify/functions/call-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model,
                userQuery,
                responseSchema
            }),
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erreur API:', response.status, errorText);
            throw new Error(`Erreur ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        console.log('R√©ponse IA re√ßue avec succ√®s');
        return result;

    } catch (error) {
        console.error("Erreur appel IA:", error);
        console.log('Fallback vers simulation');
        return {
            text: generateMockResponse(userQuery)
        };
    }
}

function generateMockResponse(prompt) {
    if (prompt.includes('syst√©matiser')) {
        return "Cr√©er un template Notion avec checklist + enregistrer une vid√©o Loom du process.";
    }
    if (prompt.includes('optimiser cette offre')) {
        return "1. Augmenter le prix de 20% vu la valeur\n2. Cr√©er une version groupe pour scaler\n3. Ajouter un upsell de suivi mensuel";
    }
    if (prompt.includes('SWOT')) {
        return `Forces:
- Expertise reconnue dans le domaine
- Base clients fid√®le et engag√©e
- Processus bien document√©s

Faiblesses:
- D√©pendance excessive au fondateur
- Manque d'automatisation des t√¢ches r√©p√©titives
- Communication interne perfectible

Opportunit√©s:
- March√© en forte croissance
- Possibilit√© de cr√©er des offres compl√©mentaires
- Potentiel de partenariats strat√©giques

Menaces:
- Concurrence qui se structure
- Risque de burnout du dirigeant
- D√©pendance √† quelques gros clients`;
    }
    if (prompt.includes('r√©sum√© ex√©cutif')) {
        return `Ton business tourne, mais tu es le hamster dans la roue. Les chiffres sont bons (f√©licitations!), mais √† quel prix ? Tu travailles 60h/semaine, ton √©quipe attend tes validations pour respirer, et tes derni√®res vraies vacances remontent √†... jamais. Le risque ? Un burnout qui te co√ªtera bien plus cher que n'importe quel investissement en structuration.

La bonne nouvelle : tous les signaux sont au vert pour transformer ton business en machine autonome. Ton √©quipe a le potentiel (elle manque juste de process clairs et d'autonomie), tes offres cartonnent (mais pourraient √™tre optimis√©es pour scaler), et tu as d√©j√† 80% des outils n√©cessaires (ils sont juste mal utilis√©s). En 6 mois, on peut inverser la tendance.

Tes 3 actions prioritaires : 1) Documenter imm√©diatement tes 5 process les plus critiques (2h max par process avec Loom), 2) Identifier ton futur "bras droit" dans ton √©quipe actuelle et commencer √† lui d√©l√©guer progressivement, 3) Bloquer 1 journ√©e OFF par semaine d√®s maintenant (oui, maintenant) pour reprendre le contr√¥le de ton temps. Le reste suivra.`;
    }
    return "Analyse en cours... [R√©ponse simul√©e pour test]";
}

/* ============================
  Brainstorming avec T√©√ØLie
============================ */
window.showBrainstorm = function(auditId) {
  currentAuditId = auditId;
  const audit = audits.find(a => a.id === auditId);
  if (!audit) return;
  
  hideAllSections();
  
  if (!audit.brainstormHistory) {
    audit.brainstormHistory = [];
  }
  
  const el = document.createElement('div');
  el.innerHTML = renderNavigation(auditId, 'brainstorm');
  
  const content = document.createElement('div');
  content.className = 'content-section';
  content.innerHTML = `
    <h2 style="color: var(--p)">üí° Brainstorm avec T√©√ØLie</h2>
    <p class="muted">Un espace libre pour explorer des id√©es strat√©giques, challenger des hypoth√®ses, ou simplement r√©fl√©chir √† voix haute avec T√©√ØLie.</p>
    
    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
      <div style="display: flex; gap: 10px; align-items: flex-start; margin-bottom: 15px;">
        <select id="brainstorm-ai-selector" class="btn-sm" style="padding: 8px 12px; border: 1px solid var(--border-color); flex-shrink: 0;">
          <option value="gemini">T√©√ØLie (Gemini)</option>
          <option value="claude">T√©√ØLie (Claude)</option>
          <option value="chatgpt">T√©√ØLie (ChatGPT)</option>
        </select>
        <div style="flex: 1;">
          <textarea id="brainstorm-input" 
                    placeholder="Ex: J'h√©site entre recruter un assistant virtuel ou automatiser avec Zapier, qu'en penses-tu ?"
                    style="width: 100%; min-height: 80px; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-family: inherit; resize: vertical;"></textarea>
        </div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-info" onclick="sendBrainstormMessage('${auditId}')">
          Envoyer √† T√©√ØLie <span id="brainstorm-loader" class="loader hidden"></span>
        </button>
        <button class="btn btn-secondary" onclick="clearBrainstormHistory('${auditId}')">
          Effacer l'historique
        </button>
      </div>
    </div>
    
    <div id="brainstorm-chat" style="background: white; border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; min-height: 400px; max-height: 600px; overflow-y: auto;">
      ${renderBrainstormHistory(audit.brainstormHistory)}
    </div>
  `;
  
  el.appendChild(content);
  $app.appendChild(el);
  
  setTimeout(() => {
    const chat = document.getElementById('brainstorm-chat');
    if (chat) chat.scrollTop = chat.scrollHeight;
  }, 100);
  
  document.getElementById('brainstorm-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
      sendBrainstormMessage(auditId);
    }
  });
};

function renderBrainstormHistory(history) {
  if (!history || history.length === 0) {
    return `<div style="text-align: center; color: #999; padding: 40px;">
      <p style="font-size: 1.2rem; margin-bottom: 10px;">üí¨</p>
      <p>L'espace est vide. Pose une premi√®re question √† T√©√ØLie !</p>
      <p class="small" style="margin-top: 10px;">Astuce : Ctrl + Entr√©e pour envoyer rapidement</p>
    </div>`;
  }
  
  return history.map(msg => {
    const isUser = msg.role === 'user';
    const bgColor = isUser ? 'var(--bg-light)' : 'var(--bg-secondary)';
    const align = isUser ? 'flex-end' : 'flex-start';
    const name = isUser ? 'Toi' : 'T√©√ØLie';
    const icon = isUser ? 'üë§' : 'ü§ñ';
    
    return `
      <div style="display: flex; justify-content: ${align}; margin-bottom: 20px;">
        <div style="max-width: 75%; background: ${bgColor}; padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
          <div style="font-weight: 600; margin-bottom: 8px; color: var(--g1);">
            ${icon} ${name}
            <span style="font-size: 0.75rem; font-weight: normal; color: #999; margin-left: 8px;">
              ${new Date(msg.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
            </span>
          </div>
          <div style="line-height: 1.6; white-space: pre-wrap;">${escapeHtml(msg.content)}</div>
        </div>
      </div>
    `;
  }).join('');
}

window.sendBrainstormMessage = async function(auditId) {
  const audit = audits.find(a => a.id === auditId);
  if (!audit) return;
  
  const input = document.getElementById('brainstorm-input');
  const loader = document.getElementById('brainstorm-loader');
  const chat = document.getElementById('brainstorm-chat');
  const message = input.value.trim();
  
  if (!message) return;
  
  if (!audit.brainstormHistory) audit.brainstormHistory = [];
  audit.brainstormHistory.push({
    role: 'user',
    content: message,
    timestamp: new Date().toISOString()
  });
  
  input.value = '';
  loader.classList.remove('hidden');
  input.disabled = true;
  
  chat.innerHTML = renderBrainstormHistory(audit.brainstormHistory);
  chat.scrollTop = chat.scrollHeight;
  
  try {
    let context = `Tu es T√©√ØLie, une COO de g√©nie qui aide ${audit.clientInfo.firstName} (CEO de ${audit.clientInfo.businessName}).
    
Contexte du business :
- CA : ${audit.clientInfo.revenue}
- √âquipe : ${audit.clientInfo.teamSize}
- Objectifs : ${audit.clientInfo.priorityObjectives}
- Probl√®mes : ${audit.clientInfo.mainProblems}

R√©ponds de mani√®re directe, concr√®te et actionnables. Sois cash mais bienveillante. Tu peux challenger les id√©es et proposer des alternatives.

Question de ${audit.clientInfo.firstName} : ${message}`;
    
    const model = document.getElementById('brainstorm-ai-selector').value;
    const result = await callAI(model, context);
    
    if (result && result.text) {
      audit.brainstormHistory.push({
        role: 'assistant',
        content: result.text,
        timestamp: new Date().toISOString()
      });
      
      audit.lastModified = new Date().toISOString();
      saveAudits();
      chat.innerHTML = renderBrainstormHistory(audit.brainstormHistory);
      chat.scrollTop = chat.scrollHeight;
    } else {
      throw new Error('Pas de r√©ponse de T√©√ØLie');
    }
  } catch (e) {
    audit.brainstormHistory.push({
      role: 'assistant',
      content: `‚ùå Erreur : ${e.message}. R√©essaye dans quelques instants.`,
      timestamp: new Date().toISOString()
    });
    chat.innerHTML = renderBrainstormHistory(audit.brainstormHistory);
  } finally {
    loader.classList.add('hidden');
    input.disabled = false;
    input.focus();
  }
};

window.clearBrainstormHistory = function(auditId) {
  const audit = audits.find(a => a.id === auditId);
  if (!audit) return;
  
  if (confirm('Effacer tout l\'historique du brainstorming ?')) {
    audit.brainstormHistory = [];
    audit.lastModified = new Date().toISOString();
    saveAudits();
    document.getElementById('brainstorm-chat').innerHTML = renderBrainstormHistory([]);
  }
};

/* ============================
  Personalized Audit Generation
============================ */
function determineAuditPriorities(audit){
  const pr=[];
  if (audit.entryData.q_deconnexion && audit.entryData.q_deconnexion.length > 10) pr.push('productivity');
  if (audit.entryData.q_goulot && audit.entryData.q_goulot.toLowerCase().includes('moi')) pr.push('delegation');
  if (audit.entryData.q_equipe_autonomie && (audit.entryData.q_equipe_autonomie.startsWith('1') || audit.entryData.q_equipe_autonomie.startsWith('2') || audit.entryData.q_equipe_autonomie.startsWith('3'))) pr.push('systems');
  if(parseRevenueToNumber(audit.clientInfo.revenue)>500000) pr.push('offers');
  return pr;
}

function generatePersonalizedAudit(audit){
  const priorities = determineAuditPriorities(audit);
  let phases=[];

  phases.push({
    id:'productivity', name:'Productivit√© & Temps',
    priority: priorities.includes('productivity')?'HIGH':'MEDIUM',
    description:'Analyse de ta gestion du temps et productivit√©',
    questions:[
      {id:'time_management',text:'Comment g√®res-tu actuellement ton temps et tes priorit√©s ?',type:'textarea',category:'Temps', placeholder: "Ex: J'utilise Notion mais c'est le chaos. Je passe mes journ√©es √† √©teindre des incendies plut√¥t qu'√† avancer sur ce qui compte vraiment."},
      {id:'productivity_table',text:'D√©taille tes principales activit√©s hebdomadaires',type:'table',category:'Analyse D√©taill√©e',
       columns:[
         {id:'tache',name:'T√¢che/Activit√©',type:'text'},
         {id:'heures',name:'Heures/semaine',type:'number'},
         {id:'plaisir',name:'Plaisir',type:'select',options:["J'adore","J'aime",'Neutre',"Je d√©teste"]},
         {id:'competence',name:'Niveau',type:'select',options:['Expert','Bon','Moyen','D√©butant']},
         {id:'statut',name:'Statut',type:'select',options:['√Ä garder','√Ä d√©l√©guer','√Ä syst√©matiser','D√©l√©gu√©']},
         {id:'delegue_a', name:'D√©l√©gu√© √† (poste/pr√©nom)', type:'text'},
         {id:'sop_fait', name:'SOP fait ?', type:'select', options:['Non', 'En cours', 'Oui']},
         {id:'avis_systematisation', name: 'Avis de T√©√ØLie (Syst√©matisation)', type: 'textarea'}
       ]
      },
      {id:'generate_productivity_avis', type:'ai_button', text: 'üß† Analyser les t√¢ches avec T√©√ØLie', action: `generateAllProductivityAvis('${audit.id}', 'productivity')` },
      {id:'biggest_time_wasters',text:'Tes plus gros "voleurs de temps" ?',type:'textarea',category:'Blocages', placeholder: "Ex: Les questions de l'√©quipe qui pourraient √™tre dans un process, les 'petites' interruptions qui me d√©foncent ma concentration..."}
    ]
  });

  phases.push({
    id:'tools', name:'Outils & Syst√®mes',
    priority: priorities.includes('systems')?'HIGH':'MEDIUM',
    description:'Audit de tes outils et syst√®mes',
    questions:[
      {id:'current_tools',text:'Quels outils utilises-tu au quotidien ?',type:'textarea',category:'Outils', placeholder: "Ex: Stripe, ActiveCampaign, Notion, Slack, Google Drive, Calendly, Tally... et probablement 10 autres dont j'ai oubli√© le mot de passe."},
      {id:'tools_table',text:"Inventaire d√©taill√© (doublons, co√ªts)",type:'table',category:'Analyse D√©taill√©e',
       columns:[
         {id:'nom',name:"Nom de l'outil",type:'text'},
         {id:'type',name:'Type',type:'select',options:['Autor√©pondeur','Programmation RS','Cr√©ation visuels','CRM','Formation','Paiement','Comptabilit√©','Calendrier','Communication','Stockage','Analytics','Site web','Autre']},
         {id:'prix',name:'Prix',type:'number'},
         {id:'monnaie',name:'Monnaie',type:'select',options:['EUR', 'USD', 'CAD', 'CHF']},
         {id:'frequence',name:'Fr√©quence',type:'select',options:['Mensuel','Annuel','Unique','Gratuit']},
         {id:'annuel_calcule',name:'Co√ªt annuel (‚Ç¨)',type:'calculated'},
         {id:'qui_l_utilise',name:"Qui l'utilise ?", type:'select', options:['Moi uniquement', "Toute l'√©quipe", 'Partie √©quipe', 'Clients aussi', 'Prestataires externes']},
         {id:'fonction',name:'Fonction principale',type:'text'},
         {id:'decision',name:'D√©cision',type:'select',options:['√Ä garder','√Ä supprimer','√Ä remplacer','√Ä √©valuer']}
       ]
      },
      {id:'tool_satisfaction',text:'Satisfait de tes outils ?',type:'select',category:'Satisfaction',
       options:['Tr√®s satisfait','Plut√¥t satisfait','Moyennement satisfait','Peu satisfait','Pas du tout satisfait']},
      { type: 'subheading', text: '‚öôÔ∏è Audit des Syst√®mes & Processus' },
      { id: 'system_acquisition', text: 'Syst√®me d\'Acquisition & Vente', type: 'textarea', category: 'Syst√®mes', context: "Comment un inconnu devient-il un client chez toi ? D√©cris-moi les √©tapes. Est-ce un chemin balis√© (tunnel de vente, process d'appel clair) ou est-ce que √ßa d√©pend de la m√©t√©o et de ton humeur ?", placeholder: "Ex: Pub FB > Page de vente > Achat > Email de bienvenue. C'est assez clair mais je pourrais optimiser l'upsell." },
      { id: 'system_onboarding', text: 'Syst√®me d\'Onboarding Client', type: 'textarea', category: 'Syst√®mes', context: "Quand un client signe (Bravo ! üéâ), que se passe-t-il ensuite ? Est-ce le d√©but d'une exp√©rience 5 √©toiles automatis√©e (contrat, facture, acc√®s, cadeau de bienvenue...) ou le d√©but du \"ah merde, j'ai oubli√© de lui envoyer le lien...\" ?", placeholder: "Ex: Je lui envoie un email manuel avec tous les liens. C'est un peu artisanal et √ßa me prend du temps." },
      { id: 'system_delivery', text: 'Syst√®me de D√©livrance (Op√©rations)', type: 'textarea', category: 'Syst√®mes', context: "Comment ton produit/service est-il livr√© ? Pour un coaching, un mastermind, une formation... Quelles sont les √©tapes r√©currentes ? Est-ce que c'est fluide et standardis√© pour tout le monde ?", placeholder: "Ex: Pour mes coachings, j'ai un template de suivi sur Notion, mais chaque client est un peu un cas √† part." },
      { id: 'system_project_management', text: 'Syst√®me de Gestion de Projet & √âquipe', type: 'textarea', category: 'Syst√®mes', context: "Comment les projets avancent ? O√π sont centralis√©es les informations ? Comment sais-tu qui fait quoi et o√π √ßa en est, sans avoir √† demander 15 fois par jour ? (Spoiler : si la r√©ponse est \"sur WhatsApp\", on a un probl√®me).", placeholder: "Ex: On a un Trello mais personne ne le met √† jour. On passe notre vie en r√©union ou sur Slack pour savoir o√π on en est." },
      { id: 'system_sops', text: 'Documentation des Process (SOPs) sur 10', type: 'textarea', category: 'Syst√®mes', context: "Si tu √©tais kidnapp√© par des aliens demain üëΩ, est-ce que ton √©quipe pourrait continuer √† faire tourner la boutique en suivant des proc√©dures claires ? Note de 1 √† 10.", placeholder: "Ex: 3/10. La plupart des process sont dans ma t√™te. Si je ne suis pas l√†, c'est la panique." }
    ]
  });

  phases.push({
    id:'offers', name:'Analyse des Offres',
    priority: priorities.includes('offers')?'HIGH':'MEDIUM',
    description:'Audit de tes offres et de leur rentabilit√©',
    questions:[
      {id:'offers_overview',text:'Pr√©sente tes offres/services',type:'textarea',category:'Offres', placeholder: "Ex: \n- Offre 'Starter' (formation en ligne) \n- Offre 'Booster' (Mastermind) \n- Offre '√âlite' (Coaching 1:1)"},
      {id:'offers_detailed_table',text:'D√©tail financier & Strat√©gie par offre',type:'table',category:'Analyse financi√®re',
       columns:[
         {id:'nom_offre',name:"Nom de l'offre",type:'text'},
         {id:'prix',name:'Prix (‚Ç¨)',type:'number'},
         {id:'nb_ventes_12mois',name:'Ventes (12 mois)',type:'number'},
         {id:'couts',name:'Co√ªts (‚Ç¨)',type:'number'},
         {id:'ca_12mois',name:'CA 12 mois (‚Ç¨)',type:'calculated'},
         {id:'marge_unitaire', name:'Marge Unitaire (‚Ç¨)', type: 'calculated'},
         {id:'marge_annuelle', name:'Marge Annuelle (‚Ç¨)', type: 'calculated'},
         {id:'marge_nette',name:'Marge nette (%)',type:'calculated_margin'},
         {id:'temps_CEO',name:'Temps CEO/client',type:'text'},
         {id:'scalable',name:'Scalable ?',type:'select',options:['Oui, totalement','Partiellement','Non, tr√®s manuel']},
         {id:'objectif', name:'Objectif Strat√©gique', type: 'select', options:['D√©velopper', 'Optimiser', 'Maintenir', 'Arr√™ter']},
         {id:'parcours', name:'Parcours Client', type:'action_button', text: 'üó∫Ô∏è Cartographier'},
         {id:'avis_actions', name: 'Avis & Actions (T√©√ØLie)', type: 'textarea'},
       ]
      },
      {id:'generate_offer_recommendations', type:'ai_button', text: 'üéØ G√©n√©rer les plans d\'action pour toutes les offres avec T√©√ØLie', action: `generateAllOfferActions('${audit.id}', 'offers')` }
    ]
  });
  
  phases.push({
    id:'organization', name:'Organisation & √âquipe',
    priority: priorities.includes('organization')?'HIGH':'MEDIUM',
    description:"Audit de la structure interne, du management et de la d√©l√©gation",
    questions:[
        { type: 'subheading', text: 'üëë Partie 1 : Organisation Actuelle du CEO' },
        { id: 'orga_heures_actuelles', text: 'Heures r√©elles travaill√©es par semaine', type: 'textarea', context: "Sois honn√™te, combien d'heures par semaine ? Essaye de r√©partir (ex: 20h client, 15h admin, 10h marketing...)", placeholder: "Ex: Environ 60h. 25h en calls client, 20h d'op√©rationnel/admin, 10h de marketing, 5h de 'je sais pas o√π est pass√© mon temps'." },
        { id: 'orga_semaine_actuelle', text: 'Semaine type actuelle d√©taill√©e', type: 'textarea', context: "Raconte-moi une semaine type, du lundi matin au dimanche soir. Qu'est-ce qui te pompe le plus d'√©nergie ?", prefillId: 'q_semaine_type' },
        { id: 'orga_gestion_off', text: 'Comment tu t\'organises quand tu es OFF ?', type: 'textarea', context: "Le week-end, le soir... Arrives-tu √† couper ? Quelle est la tentation n¬∞1 de replonger dans le pro ?", placeholder: "Ex: 'OFF' ? C'est quoi ce mot ? Je checke mes mails le soir et le week-end 'juste au cas o√π'. La d√©connexion, c'est de la science-fiction pour moi." },
        
        { type: 'subheading', text: 'üèõÔ∏è Partie 2 : Le Tetris du Temps - Audit du Calendrier' },
        { 
            id: 'orga_calendrier_actuel', 
            text: "Calendrier d'une semaine type (Avant)", 
            type: 'schedule_table', 
            context: "Remplis les blocs ci-dessous pour cartographier la semaine type actuelle. Pas de triche, on veut le vrai, le brut, le chaotique."
        },
        
        { type: 'subheading', text: 'üåü Partie 3 : Semaine R√™v√©e D√©taill√©e' },
        { id: 'orga_semaine_revee', text: 'Description de sa semaine id√©ale', type: 'textarea', context: "Maintenant, la vision ! Du lundi au dimanche, √† quoi ressemble la semaine qui lui ferait dire 'j'ai la meilleure vie' ?", prefillId: 'q_semaine_ideale', placeholder: "Ex: Lundi : Strat√©gie & Vision (matin), OFF (apr√®m). Mardi/Mercredi : Calls clients importants. Jeudi : Cr√©ation de contenu. Vendredi : OFF. 30h/semaine max." },
        { id: 'orga_repartition_revee', text: 'R√©partition id√©ale des heures', type: 'textarea', context: "Dans cette semaine de r√™ve, combien d'heures sont allou√©es √† la strat√©gie, √† la cr√©ation, au management, et surtout... √† lui/elle ?", placeholder: "Ex: 10h Strat√©gie/Vision, 10h Calls clients 'zone de g√©nie', 5h Cr√©ation, 5h Management de haut niveau. 0h d'op√©rationnel." },
        { id: 'orga_gestion_off_revee', text: 'Gestion id√©ale des p√©riodes OFF', type: 'textarea', context: "Comment g√®re-t-il/elle ses soir√©es, week-ends et vacances dans ce sc√©nario id√©al ?", placeholder: "Ex: Le soir, le t√©l√©phone pro est en mode avion. Le week-end, il est dans un tiroir. Les vacances, c'est 100% OFF, car T√©√ØLie et mon √©quipe g√®rent la boutique." },
        
        { type: 'subheading', text: 'üå¥ Partie 4 : Gestion des Vacances' },
        { id: 'orga_vacances_travail', text: 'Bosses-tu pendant tes vacances ?', type: 'yesno', category: 'Vacances'},
        { id: 'vacances_questions_container', type: 'container_start', dependsOn: 'orga_vacances_travail'},
        {
            id: 'orga_vacances_organisation',
            text: 'Si oui, comment t\'organises-tu ?',
            type: 'textarea',
            context: "D√©cris-moi une semaine type de travail en vacances. Ex: 'Je bosse 2h le matin avant que tout le monde se l√®ve pour √©teindre les feux, et je re-check 1h le soir.'",
            prefillId: 'q_perso_vacances_travail',
            placeholder: "Lundi matin: 2h urgences...\n..."
        },
        {
            id: 'orga_vacances_choix',
            text: 'Est-ce par choix ou par obligation ?',
            type: 'textarea',
            context: "Sois honn√™te : est-ce que tu bosses parce que tu aimes garder un oeil, ou parce que tu as peur que tout s'√©croule si tu n'es pas l√† ?",
            prefillId: 'q_perso_vacances_choix',
            placeholder: "Ex: C'est une contrainte, si je pouvais je ne toucherais pas √† mon ordi. / Un peu des deux, j'aime bien garder un oeil mais je pourrais faire moins."
        },
        { id: 'vacances_questions_container', type: 'container_end' },

        { type: 'subheading', text: 'üë• Partie 5 : L\'√âquipe pour R√©aliser le R√™ve' },
        { id: 'has_team', text:'As-tu une √©quipe en place ?', type:'yesno', category:'Structure'},
        
        { id:'container-has_team-no', type:'container_start'}, 
        { 
            id: 'orga_equipe_necessaire_solo', 
            text: 'De qui aurais-tu besoin pour atteindre ta vision ?', 
            type: 'textarea', 
            context: "Puisque tu es solo, d√©cris le ou les premiers r√¥les que tu recruterais pour que ta semaine r√™v√©e devienne r√©alit√©. Pense en termes de postes ou de missions.", 
            placeholder: "Ex: Un(e) assistant(e) virtuel(le) pour g√©rer mes mails et mon calendrier. Un monteur vid√©o pour d√©l√©guer la post-production. Un expert pub pour scaler." 
        },
        { 
            id: 'orga_taches_a_deleguer_solo', 
            text: 'Les 3 t√¢ches que tu supprimerais de ta vie demain ?', 
            type: 'textarea', 
            context: "Si tu avais une baguette magique, quelles sont les 3 t√¢ches que tu d√©testerais le plus et que tu voudrais d√©l√©guer en priorit√© ?", 
            placeholder: "1. La comptabilit√©\n2. Le montage des r√©els Instagram\n3. R√©pondre aux DMs" 
        },
        { id:'container-has_team-no', type:'container_end'},

        { id:'container-has_team-yes', type:'container_start'},
        { id: 'orga_equipe_necessaire', text: 'L\'√©quipe actuelle est-elle suffisante pour ta vision ?', type: 'textarea', context: "En regardant ton √©quipe, quels postes ou comp√©tences manquent pour atteindre tes objectifs √† 3 ans ?", placeholder: "Ex: Il me manque un vrai bras droit / COO pour piloter l'op√©rationnel et me challenger sur la strat√©gie." },
        { id: 'team_members_table', text: 'D√©tail de chaque membre de l\'√©quipe actuelle', type: 'table', columns: [
            { id: 'prenom', name: 'Pr√©nom', type: 'text'},
            { id: 'poste', name: 'Poste', type: 'text'},
            { id: 'forces', name: 'Forces', type: 'textarea'},
            { id: 'faiblesses', name: 'Faiblesses / Axes d\'am√©lioration', type: 'textarea'},
            { id: 'taches', name: 'T√¢ches principales', type: 'textarea'},
            { id: 'decision', name: 'Pouvoir D√©cisionnel', type: 'textarea', context: 'Quelles d√©cisions peuvent-ils prendre en autonomie ?'}
        ]},
        { id: 'orga_potentiel_evolution', text: 'Potentiels d\'√©volution dans l\'√©quipe', type: 'textarea', context: "Vois-tu des p√©pites dans son √©quipe actuelle qui pourraient prendre plus de responsabilit√©s ?", placeholder: "Ex: Marie, mon assistante, est une p√©pite. Je pense qu'elle pourrait devenir 'Head of Customer Success' si elle √©tait bien form√©e." },
        { id: 'orga_blocages_autonomie', text: 'Blocages concrets √† l\'autonomie', type: 'textarea', context: "Qu'est-ce qui emp√™che son √©quipe d'√™tre 100% autonome AUJOURD'HUI ? Sois pr√©cis.", placeholder: "Ex: 1. Manque de process clairs (tout est dans ma t√™te). 2. Ils ont peur de prendre une d√©cision sans ma validation. 3. Je suis un control freak (il faut bien l'avouer)." },
        { id: 'orga_dysfonctionnements', text: 'Dysfonctionnements et frictions', type: 'textarea', context: "Quels sont les petits grains de sable ou les gros rochers qui ralentissent la machine √©quipe ?", placeholder: "Ex: Les infos se perdent tout le temps. Untel n'√©tait pas au courant de √ßa. On refait souvent le travail en double." },
        { id: 'orga_processus_decision', text: 'Processus d√©cisionnels', type: 'textarea', context: "Qui d√©cide de quoi ? Est-ce clair pour tout le monde ou est-ce que tout doit remonter √† toi ?", placeholder: "Ex: C'est simple : tout remonte √† moi. De la couleur d'un bouton √† la strat√©gie de lancement √† 6 chiffres." },
        { id:'container-has_team-yes', type:'container_end'}
    ]
  });

  phases.push({
    id: 'rituals_communication',
    name: 'Rituels & Communication',
    priority: 'HIGH',
    description: "Audit des rituels d'√©quipe, de la circulation de l'information et des processus de communication.",
    questions: [
        {
            id: 'rc_weekly_meeting',
            text: "La r√©union hebdo : booster d'√©nergie ou aspirateur d'√¢me ?",
            type: 'textarea',
            context: "D√©cris-moi la r√©union d'√©quipe hebdomadaire. Est-ce que tout le monde en sort avec la super-patate et un plan clair, ou c'est le genre de r√©union qui aurait pu √™tre un email ?",
            placeholder: "Ex: C'est un tour de table d'1h30 o√π tout le monde parle de ce qu'il a fait. On en sort souvent sans actions claires et un peu endormis..."
        },
        {
            id: 'rc_kpi_tracking',
            text: 'Le suivi des KPIs : tableau de bord de fus√©e ou brouillard total ?',
            type: 'textarea',
            context: "Comment les indicateurs cl√©s de performance (KPIs) sont-ils suivis et communiqu√©s √† l'√©quipe ? Est-ce que tout le monde sait si le vaisseau est en route pour la bonne plan√®te ?",
            placeholder: "Ex: J'ai un Google Sheet que je suis le seul √† comprendre. Je donne les chiffres quand on me les demande, mais ce n'est pas proactif."
        },
        {
            id: 'rc_project_end',
            text: "La fin d'un projet : c√©l√©bration ou silence radio ?",
            type: 'textarea',
            context: "Quel est le processus quand un projet se termine ? Est-ce que c'est un debrief pour s'am√©liorer, une c√©l√©bration des victoires comme √† la fin d'un film Disney, un archivage propre... ou juste le silence jusqu'au prochain incendie ?",
            placeholder: "Ex: On passe juste au projet suivant. On ne prend jamais le temps de c√©l√©brer ou de voir ce qu'on a bien ou mal fait."
        }
    ]
  });


  return {
    phases, priorities,
    generatedAt: new Date().toISOString(),
    estimatedDuration: (phases.length*45)+' minutes'
  };
}


/* ============================
  Main Audit Views
============================ */
function toggleDualContainers(value, yesContainerId, noContainerId, inputId) {
    const yesContainer = document.getElementById(yesContainerId);
    const noContainer = document.getElementById(noContainerId);
    const input = document.getElementById(inputId);
    const btnYes = document.querySelector(`[onclick*="${inputId}"][onclick*="oui"]`);
    const btnNo = document.querySelector(`[onclick*="${inputId}"][onclick*="non"]`);

    if (!input || !btnYes || !btnNo) return;

    if (value === 'oui') {
        if(yesContainer) yesContainer.style.display = 'block';
        if(noContainer) noContainer.style.display = 'none';
        input.value = 'oui';
        btnYes.classList.add('btn-success');
        btnYes.classList.remove('btn-secondary');
        btnNo.classList.add('btn-secondary');
        btnNo.classList.remove('btn-success');
    } else {
        if(yesContainer) yesContainer.style.display = 'none';
        if(noContainer) noContainer.style.display = 'block';
        input.value = 'non';
        btnNo.classList.add('btn-success');
        btnNo.classList.remove('btn-secondary');
        btnYes.classList.add('btn-secondary');
        btnYes.classList.remove('btn-success');
    }
}


function toggleTeamQuestions(value, containerId, inputId) {
    const container = document.getElementById(containerId);
    const input = document.getElementById(inputId);
    const btnYes = document.querySelector(`[onclick*="${inputId}"][onclick*="oui"]`);
    const btnNo = document.querySelector(`[onclick*="${inputId}"][onclick*="non"]`);

    if (container && input && btnYes && btnNo) {
        if (value === 'oui') {
            container.style.display = 'block';
            input.value = 'oui';
            btnYes.classList.add('btn-success');
            btnYes.classList.remove('btn-secondary');
            btnNo.classList.add('btn-secondary');
            btnNo.classList.remove('btn-success');
        } else {
            container.style.display = 'none';
            input.value = 'non';
            btnNo.classList.add('btn-success');
            btnNo.classList.remove('btn-secondary');
            btnYes.classList.add('btn-secondary');
            btnYes.classList.remove('btn-success');
        }
    }
}

/* ============================
  Table Widgets
============================ */
function renderScheduleTableWidget(question, data) {
    const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
    const timeSlots = {
        matin: 'Matin (8h-12h)',
        midi: 'Midi (12h-14h)',
        aprem: 'Apr√®s-midi (14h-18h)',
        soir: 'Soir√©e (18h+)'
    };

    let html = `<div class="table-widget-container" style="overflow-x: auto;">
        <table id="schedule-table-${question.id}" class="dynamic-table schedule-table">
            <thead>
                <tr>
                    <th>Jour</th>
                    ${Object.values(timeSlots).map(slot => `<th>${slot}</th>`).join('')}
                </tr>
            </thead>
            <tbody>
    `;

    days.forEach(day => {
        html += `<tr><td><strong>${day}</strong></td>`;
        Object.keys(timeSlots).forEach(slotId => {
            const value = data && data[day] && data[day][slotId] ? data[day][slotId] : '';
            html += `<td><textarea data-day="${day}" data-slot="${slotId}" class="audit-input schedule-input" placeholder="Activit√©s...">${escapeHtml(value)}</textarea></td>`;
        });
        html += `</tr>`;
    });

    html += `
            </tbody>
        </table>
    </div>`;
    return html;
}

function renderTableWidget(question, data, auditId, phaseId) {
    const tableId = `table-widget-${question.id}`;
    let rowsHTML = '';
    const dataToRender = (data && data.length > 0) ? data : [{}];

    dataToRender.forEach((rowData, rowIndex) => {
        rowsHTML += `<tr data-row-index="${rowIndex}">`;
        question.columns.forEach(col => {
            const value = rowData[col.id] || '';
            let cellContent = '';

            switch (col.type) {
                case 'text':
                case 'number':
                    cellContent = `<input type="${col.type}" data-col-id="${col.id}" value="${escapeHtml(value)}" class="audit-input">`;
                    break;
                case 'textarea':
                    cellContent = `<textarea data-col-id="${col.id}" class="audit-input">${escapeHtml(value)}</textarea>`;
                    break;
                case 'select':
                    cellContent = `<select data-col-id="${col.id}" class="audit-input">
                        ${col.options.map(opt => `<option value="${escapeHtml(opt)}" ${value === opt ? 'selected' : ''}>${escapeHtml(opt)}</option>`).join('')}
                    </select>`;
                    break;
                case 'calculated':
                case 'calculated_margin':
                    cellContent = `<span class="calculated-value" data-col-id="${col.id}"></span>`;
                    break;
                case 'action_button':
                    if (question.id === 'offers_detailed_table' && col.id === 'parcours') {
                       cellContent = `<button type="button" class="btn btn-secondary btn-sm" onclick="showParcoursClient('${auditId}', '${phaseId}', ${rowIndex})">${col.text}</button>`;
                    }
                    break;
                default:
                    cellContent = escapeHtml(value);
            }
            rowsHTML += `<td>${cellContent}</td>`;
        });
        rowsHTML += `<td><button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">X</button></td>`;
        rowsHTML += `</tr>`;
    });

    return `
        <div class="table-widget-container" style="overflow-x: auto;">
            <table id="${tableId}" class="dynamic-table" data-question-id="${question.id}">
                <thead>
                    <tr>
                        ${question.columns.map(c => `<th>${escapeHtml(c.name)} ${c.context ? `<p class="small" style="margin:0; font-weight:normal;">${escapeHtml(c.context)}</p>` : ''}</th>`).join('')}
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHTML}
                </tbody>
            </table>
        </div>
        <button type="button" class="btn btn-sm btn-secondary" style="margin-top:10px;" onclick="addRow('${tableId}')">+ Ajouter une ligne</button>
    `;
}

function addRow(tableId) {
    const table = document.getElementById(tableId);
    const questionId = table.dataset.questionId;
    const audit = audits.find(a => a.id === currentAuditId);
    if (!audit || !audit.personalizedAudit) return;

    let question;
    for (const phase of audit.personalizedAudit.phases) {
        const q = phase.questions.find(q => `table-widget-${q.id}` === tableId);
        if (q) {
            question = q;
            break;
        }
    }
    if (!question) return;

    const tbody = table.querySelector('tbody');
    const newIndex = tbody.rows.length;
    const newRow = tbody.insertRow();
    newRow.dataset.rowIndex = newIndex;

    question.columns.forEach(col => {
        const cell = newRow.insertCell();
        let cellContent = '';
        switch (col.type) {
            case 'text':
            case 'number':
                cellContent = `<input type="${col.type}" data-col-id="${col.id}" value="" class="audit-input">`;
                break;
            case 'textarea':
                cellContent = `<textarea data-col-id="${col.id}" class="audit-input"></textarea>`;
                break;
            case 'select':
                cellContent = `<select data-col-id="${col.id}" class="audit-input">
                    ${col.options.map(opt => `<option value="${escapeHtml(opt)}">${escapeHtml(opt)}</option>`).join('')}
                </select>`;
                break;
            case 'calculated':
            case 'calculated_margin':
                cellContent = `<span class="calculated-value" data-col-id="${col.id}"></span>`;
                break;
             case 'action_button':
                if (question.id === 'offers_detailed_table' && col.id === 'parcours') {
                   cellContent = `<button type="button" class="btn btn-secondary btn-sm" onclick="showParcoursClient('${currentAuditId}', '${table.closest('form').dataset.phaseId}', ${newIndex})">${col.text}</button>`;
                }
                break;
        }
        cell.innerHTML = cellContent;
    });

    const actionCell = newRow.insertCell();
    actionCell.innerHTML = `<button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">X</button>`;

    newRow.querySelectorAll('.audit-input').forEach(input => {
        input.addEventListener('input', () => updateCalculatedCells(newRow));
    });
}

function deleteRow(btn) {
    const row = btn.closest('tr');
    if (row.parentElement.rows.length > 1) {
        row.remove();
    } else {
        row.querySelectorAll('.audit-input').forEach(input => {
            if(input.tagName === 'SELECT') input.selectedIndex = 0;
            else input.value = '';
        });
        updateCalculatedCells(row);
    }
}

function updateCalculatedCells(row) {
    const table = row.closest('.dynamic-table');
    if (!table) return;
    const questionId = table.dataset.questionId;

    const getValue = (colId) => {
        const input = row.querySelector(`[data-col-id="${colId}"]`);
        return input ? input.value : null;
    };
    
    const getNumericValue = (colId) => {
        return parseFloat(getValue(colId)) || 0;
    };

    const setContent = (colId, content, className = '') => {
        const el = row.querySelector(`[data-col-id="${colId}"]`);
        if (el) {
            el.innerHTML = content;
            if (className) {
                el.closest('td').classList.remove('marge-cell-bad', 'marge-cell-ok', 'marge-cell-good');
                el.closest('td').classList.add(className);
            }
        }
    };

    if (questionId === 'tools_table') {
        const price = getNumericValue('prix');
        const currency = getValue('monnaie');
        const freq = getValue('frequence');
        let annualCost = 0;
        let rate = 1;
        if (currency === 'USD') rate = 0.92;
        if (currency === 'CAD') rate = 0.68;
        if (currency === 'CHF') rate = 1.02;

        const priceInEur = price * rate;

        if (freq === 'Annuel') annualCost = priceInEur;
        if (freq === 'Mensuel') annualCost = priceInEur * 12;
        if (freq === 'Unique') annualCost = priceInEur;
        
        setContent('annuel_calcule', euro(annualCost.toFixed(2)));
    }

    if (questionId === 'offers_detailed_table') {
        const price = getNumericValue('prix');
        const sales = getNumericValue('nb_ventes_12mois');
        const costs = getNumericValue('couts');

        const ca = price * sales;
        const marginUnit = price - costs;
        const marginAnnual = marginUnit * sales;
        const marginNet = ca > 0 ? (marginAnnual / ca) * 100 : 0;
        
        setContent('ca_12mois', euro(ca.toFixed(2)));
        setContent('marge_unitaire', euro(marginUnit.toFixed(2)));
        setContent('marge_annuelle', euro(marginAnnual.toFixed(2)));

        let marginClass = '';
        if (marginNet < 10) marginClass = 'marge-cell-bad';
        else if (marginNet >= 10 && marginNet < 30) marginClass = 'marge-cell-ok';
        else if (marginNet >= 30) marginClass = 'marge-cell-good';

        setContent('marge_nette', `${marginNet.toFixed(1)}%`, marginClass);
    }
}

function attachTableListeners(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    table.querySelectorAll('tbody tr').forEach(row => {
        updateCalculatedCells(row);
        row.querySelectorAll('.audit-input').forEach(input => {
            input.addEventListener('input', () => updateCalculatedCells(row));
        });
    });
}

function continueAudit(auditId){
  currentAuditId = auditId;
  const audit = audits.find(a => a.id === auditId); if(!audit) return;

  if(!audit.personalizedAudit){ showAuditSetup(auditId); return; }
  if(!audit.cultureData){ showCultureAndAvatar(auditId); return; }

  const next = audit.personalizedAudit.phases.find(p=>!audit.phaseSWOTs[p.id]);
  if(next){ startAuditPhase(auditId, next.id); }
  else if(checkForFinalSynthesis(audit)){ generateFinalSynthesis(auditId); }
  else { showAuditOverview(auditId); }
}

function showAuditOverview(auditId){
  currentAuditId = auditId;
  const audit = audits.find(a => a.id === auditId); if(!audit) return;
  hideAllSections();
  const phases = audit.personalizedAudit.phases;
  
  const el = document.createElement('div');
  el.innerHTML = renderNavigation(auditId, 'overview');

  const content = document.createElement('div');
  content.className = 'content-section';

  const clientObjectives = audit.clientInfo.priorityObjectives.split('\n').filter(o => o.trim() !== '').map(o => `<li>${escapeHtml(o)}</li>`).join('');
  const clientFrustrations = (audit.entryData.q_frustrations || 'Non renseign√©').split('\n').filter(f => f.trim() !== '').map(f => `<li>${escapeHtml(f)}</li>`).join('');

  content.innerHTML = `
    <h2 style="color: var(--p); text-align: center; margin-bottom: 24px;">üìä Tableau de bord CEO ‚Äì ${escapeHtml(audit.clientInfo.firstName)} ${escapeHtml(audit.clientInfo.lastName)}</h2>
    
    <div class="grid grid-2" style="margin-bottom: 24px;">
        <div class="gradient-box">
            <h3>üéØ Objectifs Prioritaires</h3>
            <ul style="padding-left: 20px; font-size: 0.95rem;">
                ${clientObjectives || '<li>Aucun objectif d√©fini.</li>'}
            </ul>
        </div>
        <div class="gradient-box" style="background: linear-gradient(135deg, #4c4c4c, #2d3142);">
            <h3>üò§ Points de Friction Majeurs</h3>
            <ul style="padding-left: 20px; font-size: 0.95rem;">
                ${clientFrustrations || '<li>Aucune frustration list√©e.</li>'}
            </ul>
        </div>
    </div>

    <div style="text-align: right; margin-bottom: 16px;">
        <button class="btn btn-info btn-sm" onclick="exportAuditAsJSON('${auditId}')">Exporter en JSON</button>
    </div>
    
    <h3>Phases de l'audit</h3>
    <div class="grid" style="gap: 12px;">
      ${phases.map(ph=>{
        const completed = !!(audit.phaseSWOTs[ph.id] && audit.phaseSWOTs[ph.id].swot && audit.phaseSWOTs[ph.id].swot.strengths);
        const badge = completed?`<span style="color:var(--ok)">‚úÖ Compl√©t√©e</span>`:`<span style="color:var(--warn)">‚è≥ √Ä faire</span>`;
        return `
          <div class="action-card" onclick="saveAndNavigate('${auditId}', 'startAuditPhase', '${auditId}', '${ph.id}')">
            <div style="text-align:left;">
              <h3 style="margin-bottom:4px">${escapeHtml(ph.name)}</h3>
              <p class="muted" style="margin:0 0 6px">${escapeHtml(ph.description)}</p>
              ${badge}
            </div>
          </div>
        `;
      }).join('')}
    </div>

    <div style="text-align:center;margin-top:24px">
      ${checkForFinalSynthesis(audit)
        ? `<button class="btn btn-success" onclick="generateFinalSynthesis('${auditId}')">üéØ G√©n√©rer le Rapport Final</button>`
        : `<button class="btn btn-success" disabled title="Compl√©tez toutes les phases pour g√©n√©rer le rapport">üéØ G√©n√©rer le Rapport Final</button>`}
    </div>
  `;
  el.appendChild(content);
  $app.appendChild(el);
}

function populateOffersTableFromText(text) {
    const tableId = 'table-widget-offers_detailed_table';
    const table = document.getElementById(tableId);
    if (!table) return;

    const tbody = table.querySelector('tbody');
    
    const existingData = [];
    tbody.querySelectorAll('tr').forEach(row => {
        const rowData = {};
        const nameInput = row.querySelector('[data-col-id="nom_offre"]');
        if (nameInput && nameInput.value) {
             row.querySelectorAll('.audit-input').forEach(input => {
                rowData[input.dataset.colId] = input.value;
             });
             existingData.push(rowData);
        }
    });
    
    tbody.innerHTML = '';

    const offerNames = text.split('\n')
        .map(line => line.replace(/^[-\*]\s*/, '').trim())
        .filter(line => line.length > 0);
    
    if (offerNames.length === 0) {
        addRow(tableId);
        return;
    }

    offerNames.forEach(name => {
        addRow(tableId);
        const newRow = tbody.lastElementChild;
        const input = newRow.querySelector('[data-col-id="nom_offre"]');
        if (input) {
            input.value = name;
            const oldData = existingData.find(d => d.nom_offre === name);
            if (oldData) {
                newRow.querySelectorAll('.audit-input').forEach(inp => {
                    if (oldData[inp.dataset.colId]) {
                        inp.value = oldData[inp.dataset.colId];
                    }
                });
            }
        }
    });
}

function showParcoursClient(auditId, phaseId, rowIndex) {
    const audit = audits.find(a => a.id === auditId);
    if (!audit) return;
    
    const tableEl = document.getElementById('table-widget-offers_detailed_table');
    const rowEl = tableEl.querySelectorAll('tbody tr')[rowIndex];
    const offerNameInput = rowEl.querySelector('[data-col-id="nom_offre"]');
    const offerName = offerNameInput ? offerNameInput.value : `Offre ${rowIndex + 1}`;

    let container = document.getElementById('parcours-client-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'parcours-client-container';
        const mainTableSection = tableEl.closest('.content-section');
        mainTableSection.parentNode.insertBefore(container, mainTableSection.nextSibling);
    }
    
    const parcoursSteps = ['D√©couverte', 'Int√©r√™t', 'Consid√©ration', 'D√©cision', 'Achat', 'Fid√©lisation'];
    const parcoursColumns = [
        { id: 'action', name: 'Action' },
        { id: 'intervenant', name: 'Qui intervient ?' },
        { id: 'temps', name: 'Temps/semaine (h)' },
        { id: 'outils', name: 'Outils utilis√©s' },
        { id: 'kpis', name: 'KPIs suivis' }
    ];
    const parcoursPlaceholders = {
        'D√©couverte': { action: "Pub Instagram", intervenant: "Media Buyer", temps: "2", outils: "Business Manager", kpis: "Port√©e, CTR" },
        'Int√©r√™t': { action: "Lead Magnet (PDF)", intervenant: "Moi (cr√©ation), Automation", temps: "1", outils: "Canva, ActiveCampaign", kpis: "Taux de conversion LP" },
        'Consid√©ration': { action: "S√©quence email de 5 jours", intervenant: "Automation", temps: "0.5", outils: "ActiveCampaign", kpis: "Taux d'ouverture, clics" },
        'D√©cision': { action: "Webinaire / Appel de vente", intervenant: "Moi", temps: "5", outils: "Zoom, Calendly", kpis: "Taux de closing" },
        'Achat': { action: "Paiement & Facturation", intervenant: "Automation", temps: "0", outils: "Stripe", kpis: "CA, LTV" },
        'Fid√©lisation': { action: "Onboarding client, Support", intervenant: "Moi, Assistante", temps: "4", outils: "Notion, Slack", kpis: "Satisfaction client (NPS)" }
    };

    let tableHTML = `
      <div class="content-section">
        <h3>üó∫Ô∏è Parcours Client D√©taill√© pour : ${escapeHtml(offerName)}</h3>
        <p class="muted small">Cartographier ce parcours permet de voir les co√ªts cach√©s (en temps) et les points de friction.</p>
        <div style="overflow-x: auto;">
          <table id="parcours-table-${rowIndex}" class="parcours-table" style="min-width: 800px;">
            <thead>
              <tr>
                <th>√âtape</th>
                ${parcoursColumns.map(c => `<th>${c.name}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
    `;

     if(!audit.phaseSWOTs[phaseId]) audit.phaseSWOTs[phaseId] = {};
     if(!audit.phaseSWOTs[phaseId].responses) audit.phaseSWOTs[phaseId].responses = {};
     if(!audit.phaseSWOTs[phaseId].responses.parcours_client) audit.phaseSWOTs[phaseId].responses.parcours_client = {};
    const existingParcours = audit.phaseSWOTs[phaseId].responses.parcours_client[offerName] || {};

    let totalTime = 0;
    parcoursSteps.forEach((stepName, stepIndex) => {
        tableHTML += `<tr><td><strong>${stepName}</strong></td>`;
        parcoursColumns.forEach(col => {
            const existingValue = existingParcours[stepIndex]?.[col.id] || '';
            if (col.id === 'temps') {
                totalTime += parseFloat(existingValue) || 0;
            }
            const placeholder = parcoursPlaceholders[stepName]?.[col.id] || '';
            tableHTML += `<td><textarea data-row="${stepIndex}" data-col="${col.id}" style="min-height: 50px;" class="audit-input" placeholder="${escapeHtml(placeholder)}">${escapeHtml(existingValue)}</textarea></td>`;
        });
        tableHTML += `</tr>`;
    });

    tableHTML += `
            </tbody>
          </table>
        </div>
        <div style="text-align: right; margin-top: 10px; font-weight: bold;">
          Temps total du parcours : <span id="parcours-total-time-${rowIndex}">${totalTime.toFixed(1)}h</span> / semaine
        </div>
      </div>
    `;

    container.innerHTML = tableHTML;

    document.querySelectorAll(`#parcours-table-${rowIndex} textarea`).forEach(textarea => {
        textarea.addEventListener('input', () => {
            const stepIndex = textarea.dataset.row;
            const colId = textarea.dataset.col;

            if(!audit.phaseSWOTs[phaseId].responses.parcours_client[offerName]){
                audit.phaseSWOTs[phaseId].responses.parcours_client[offerName] = {};
            }
            if(!audit.phaseSWOTs[phaseId].responses.parcours_client[offerName][stepIndex]){
                audit.phaseSWOTs[phaseId].responses.parcours_client[offerName][stepIndex] = {};
            }
            audit.phaseSWOTs[phaseId].responses.parcours_client[offerName][stepIndex][colId] = textarea.value;

            if (colId === 'temps') {
                let newTotal = 0;
                document.querySelectorAll(`#parcours-table-${rowIndex} [data-col="temps"]`).forEach(timeInput => {
                    newTotal += parseFloat(timeInput.value) || 0;
                });
                document.getElementById(`parcours-total-time-${rowIndex}`).textContent = `${newTotal.toFixed(1)}h`;
            }
        });
    });
}

function startAuditPhase(auditId, phaseId){
  currentAuditId = auditId;
  const audit = audits.find(a => a.id === auditId); if(!audit) return;
  const phase = audit.personalizedAudit.phases.find(p => p.id === phaseId); if(!phase) return;
  hideAllSections();

  const existing = audit.phaseSWOTs?.[phaseId] || {};
  const el = document.createElement('div');
  el.innerHTML = renderNavigation(auditId, phaseId);

  const content = document.createElement('div');
  content.className='content-section';
  content.innerHTML = `
    <h2 style="color:var(--p)">üìã ${escapeHtml(phase.name)}</h2>
    <p>${escapeHtml(phase.description)}</p>
  `;

  const form = document.createElement('form');
  form.id = 'phaseForm';
  form.dataset.phaseId = phaseId;
  form.onsubmit = (e) => saveAndContinue(e, auditId, phaseId);
  form.oninput = () => debounce(() => saveCurrentForm(auditId, true), 2000);

  let in_dependent_container = false;
  let dependent_container;

  phase.questions.forEach(q => {
    if (q.type === 'container_start') {
        in_dependent_container = true;
        dependent_container = document.createElement('div');
        dependent_container.id = q.id;
        dependent_container.style.display = 'none';
        return;
    }

    if (q.type === 'container_end') {
        in_dependent_container = false;
        form.appendChild(dependent_container);
        dependent_container = null;
        return;
    }

    if (q.type === 'subheading') {
        const subheadContainer = document.createElement('div');
        subheadContainer.innerHTML = `<h3 style="margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">${escapeHtml(q.text)}</h3>`;
        const target = in_dependent_container ? dependent_container : form;
        target.appendChild(subheadContainer);
        return; 
    }
    
    if (q.type === 'ai_button') {
        const aiButtonContainer = document.createElement('div');
        aiButtonContainer.className = 'content-section';
        const loaderId = q.id + '_loader';
        aiButtonContainer.innerHTML = `<button type="button" class="btn btn-info" id="${q.id}" onclick="${q.action}">${q.text} <span id="${loaderId}" class="loader hidden"></span></button>`;
        const target = in_dependent_container ? dependent_container : form;
        target.appendChild(aiButtonContainer);
        return;
    }

    const questionContainer = document.createElement('div');
    if (q.type !== 'yesno') {
      questionContainer.className = 'content-section';
    }
    let questionHTML = `<div class="form-group"><label>${escapeHtml(q.text)}</label>`;
    
    if (q.context) {
        questionHTML += `<p class="context">${escapeHtml(q.context)}</p>`;
    }
    
    const existingResponse = existing.responses?.[q.id] || (q.prefillId && audit.entryData[q.prefillId] ? audit.entryData[q.prefillId] : '');

    if (q.type === 'yesno') {
        const inputId = q.id;
        const existingValue = existing.responses?.[inputId] || 'non';
        const yesClass = existingValue === 'oui' ? 'btn-success' : 'btn-secondary';
        const noClass = existingValue === 'non' ? 'btn-success' : 'btn-secondary';
        
        if (q.id === 'has_team') {
             questionHTML += `
                <input type="hidden" id="${inputId}" class="audit-input" value="${existingValue}">
                <button type="button" class="btn ${yesClass}" onclick="toggleDualContainers('oui', 'container-has_team-yes', 'container-has_team-no', '${inputId}')">Oui</button>
                <button type="button" class="btn ${noClass}" style="margin-left: 8px;" onclick="toggleDualContainers('non', 'container-has_team-yes', 'container-has_team-no', '${inputId}')">Non</button>
            `;
        } else {
             const containerId = (q.id === 'orga_vacances_travail') ? 'vacances_questions_container' : `container-${q.id}`;
             questionHTML += `
                <input type="hidden" id="${inputId}" class="audit-input" value="${existingValue}">
                <button type="button" class="btn ${yesClass}" onclick="toggleTeamQuestions('oui', '${containerId}', '${inputId}')">Oui</button>
                <button type="button" class="btn ${noClass}" style="margin-left: 8px;" onclick="toggleTeamQuestions('non', '${containerId}', '${inputId}')">Non</button>
            `;
        }
    } else if (q.type === 'textarea') {
      questionHTML += `<textarea id="${q.id}" class="audit-input" placeholder="${q.placeholder || ''}">${existingResponse || ''}</textarea>`;
    } else if (q.type === 'select') {
      questionHTML += `<select id="${q.id}" class="audit-input">
        ${q.options.map(opt => `<option value="${escapeHtml(opt)}" ${existingResponse === opt ? 'selected' : ''}>${escapeHtml(opt)}</option>`).join('')}
      </select>`;
    } else if (q.type === 'table') {
      questionHTML += renderTableWidget(q, existingResponse || [], auditId, phaseId);
    } else if (q.type === 'schedule_table') {
        questionHTML += renderScheduleTableWidget(q, existingResponse || {});
    }
    questionHTML += `</div>`;
    questionContainer.innerHTML = questionHTML;
    
    const target = in_dependent_container ? dependent_container : form;
    target.appendChild(questionContainer);
  });
  
  const swotContainer = document.createElement('div');
  swotContainer.className = 'content-section';
  swotContainer.innerHTML = `
      <h3>Analyse SWOT de cette phase</h3>
       <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
            <div class="form-group" style="margin:0;">
                <label for="ai-selector" style="font-size: 0.9rem; margin-bottom: 4px;">Moteur d'analyse :</label>
                <select id="ai-selector" class="btn-sm" style="padding: 8px 12px; border: 1px solid var(--border-color); color: var(--text-dark);">
                    <option value="gemini">T√©√ØLie (Gemini - √âquilibr√©)</option>
                    <option value="claude">T√©√ØLie (Claude - Analytique)</option>
                    <option value="chatgpt">T√©√ØLie (ChatGPT - Cr√©atif)</option>
                </select>
            </div>
            <button type="button" class="btn btn-info" onclick="generateSwotWithAI('${auditId}', '${phaseId}')">
                G√©n√©rer le SWOT <span id="swot-loader" class="loader hidden"></span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="generateAngleMort('${auditId}', '${phaseId}')">
                ü§ñ Quel est l'angle mort ? <span id="blindspot-loader" class="loader hidden"></span>
            </button>
        </div>
      <div class="grid grid-2">
          <div class="form-group"><label>Forces</label><textarea id="swot_strengths" placeholder="Ex: Processus bien d√©fini...">${existing.swot?.strengths || ''}</textarea></div>
          <div class="form-group"><label>Faiblesses</label><textarea id="swot_weaknesses" placeholder="Ex: Trop de temps pass√© sur des t√¢ches manuelles...">${existing.swot?.weaknesses || ''}</textarea></div>
          <div class="form-group"><label>Opportunit√©s</label><textarea id="swot_opportunities" placeholder="Ex: Automatiser avec un nouvel outil...">${existing.swot?.opportunities || ''}</textarea></div>
          <div class="form-group"><label>Menaces</label><textarea id="swot_threats" placeholder="Ex: Risque d'erreur humaine √©lev√©...">${existing.swot?.threats || ''}</textarea></div>
      </div>
       <div class="form-group" style="max-width: 300px; margin-top: 20px;">
            <label for="maturity-score">Note de maturit√© de cette phase (0-10)</label>
            <p class="context small">Cette note sera utilis√©e pour le graphique radar dans le rapport final.</p>
            <input type="number" id="maturity-score" min="0" max="10" step="0.5" value="${existing.maturityScore || ''}" style="padding: 10px; font-size: 1.2rem;">
       </div>
  `;
  form.appendChild(swotContainer);
  
  const buttonContainer = document.createElement('div');
  buttonContainer.style.marginTop = '20px';
  buttonContainer.innerHTML = `<button type="submit" class="btn btn-success">Enregistrer et Continuer</button>`;
  form.appendChild(buttonContainer);

  content.appendChild(form);
  el.appendChild(content);
  $app.appendChild(el);
  
  if (phaseId === 'offers') {
    const offersTextarea = document.getElementById('offers_overview');
    if (offersTextarea) {
        offersTextarea.addEventListener('input', (e) => populateOffersTableFromText(e.target.value));
        if (offersTextarea.value) {
            populateOffersTableFromText(offersTextarea.value);
        }
    }
  }

  if (phaseId === 'tools') {
    const toolsTextarea = document.getElementById('current_tools');
    if (toolsTextarea) {
        toolsTextarea.addEventListener('input', (e) => populateToolsTableFromText(e.target.value));
        if (toolsTextarea.value) {
            populateToolsTableFromText(toolsTextarea.value);
        }
    }
  }

  const hasTeamInput = document.getElementById('has_team');
  if (hasTeamInput) {
      toggleDualContainers(hasTeamInput.value, 'container-has_team-yes', 'container-has_team-no', 'has_team');
  }
  const worksOnVacationInput = document.getElementById('orga_vacances_travail');
  if(worksOnVacationInput) {
      toggleTeamQuestions(worksOnVacationInput.value, 'vacances_questions_container', 'orga_vacances_travail');
  }
  
  document.querySelectorAll('.dynamic-table').forEach(table => attachTableListeners(table.id));
}

function getFormData(phase) {
    const responses = {};
    phase.questions.forEach(q => {
        if (q.type === 'container_start' || q.type === 'container_end' || q.type === 'subheading' || q.type === 'ai_button') return;
        if (q.type === 'table') {
            const tableData = [];
            const tableEl = document.getElementById(`table-widget-${q.id}`);
            if (tableEl) {
                const rows = tableEl.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const rowData = {};
                    q.columns.forEach(col => {
                        if (col.type !== 'calculated' && col.type !== 'calculated_margin' && col.type !== 'action_button') {
                            const input = row.querySelector(`[data-col-id="${col.id}"]`);
                            if (input) rowData[col.id] = input.value;
                        }
                    });
                    tableData.push(rowData);
                });
            }
            responses[q.id] = tableData;
        } else if (q.type === 'schedule_table') {
            const scheduleData = {};
            const tableEl = document.getElementById(`schedule-table-${q.id}`);
            if (tableEl) {
                tableEl.querySelectorAll('textarea.schedule-input').forEach(textarea => {
                    const day = textarea.dataset.day;
                    const slot = textarea.dataset.slot;
                    if (!scheduleData[day]) {
                        scheduleData[day] = {};
                    }
                    scheduleData[day][slot] = textarea.value;
                });
            }
            responses[q.id] = scheduleData;
        } else {
            const input = document.getElementById(q.id);
            if (input) responses[q.id] = input.value;
        }
    });

    const swot = {
        strengths: document.getElementById('swot_strengths')?.value || '',
        weaknesses: document.getElementById('swot_weaknesses')?.value || '',
        opportunities: document.getElementById('swot_opportunities')?.value || '',
        threats: document.getElementById('swot_threats')?.value || '',
    };
    
    const maturityScore = document.getElementById('maturity-score')?.value || null;

    return { responses, swot, maturityScore };
}

function saveAndContinue(e, auditId, phaseId) {
    e.preventDefault();
    saveCurrentForm(auditId);
    continueAudit(auditId);
}

function populateToolsTableFromText(text) {
    const tableId = 'table-widget-tools_table';
    const table = document.getElementById(tableId);
    if (!table) return;

    const tbody = table.querySelector('tbody');
    
    const existingData = [];
    tbody.querySelectorAll('tr').forEach(row => {
        const rowData = {};
        const nameInput = row.querySelector('[data-col-id="nom"]');
        if (nameInput && nameInput.value) {
            row.querySelectorAll('.audit-input').forEach(input => {
                rowData[input.dataset.colId] = input.value;
            });
            existingData.push(rowData);
        }
    });

    tbody.innerHTML = '';

    const toolNames = text.split(/[\n,]/g)
        .map(line => line.trim())
        .filter(line => line.length > 0);
    
    if (toolNames.length === 0) {
        addRow(tableId);
        return;
    }

    toolNames.forEach(name => {
        addRow(tableId);
        const newRow = tbody.lastElementChild;
        const nameInput = newRow.querySelector('[data-col-id="nom"]');
        if (nameInput) {
            nameInput.value = name;
            const oldData = existingData.find(d => d.nom === name);
            if (oldData) {
                newRow.querySelectorAll('.audit-input').forEach(inp => {
                    const colId = inp.dataset.colId;
                    if (colId !== 'nom' && oldData[colId]) {
                       inp.value = oldData[colId];
                    }
                });
            }
        }
    });
}

/* ============================
  Initialisation
============================ */
window.addEventListener('DOMContentLoaded', () => {
  showHome();
});

</script>
</body>
</html>